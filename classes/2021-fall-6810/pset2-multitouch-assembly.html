<!DOCTYPE html>
<html>
<head>
	<title>HCI Engineering Group</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

	<!-- CSAIL ICON -->
	<link rel="CSAIL" href="../../images/icon/csail.ico" type="image/x-icon" />

	<!-- Bootstrap -->
	<link href="../../css/bootstrap.css" rel="stylesheet">
	<link href="../../css/custom-style.css" rel="stylesheet">

	<!-- jQuery -->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Abel" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Barlow" rel="stylesheet">

	<!-- Google Analytic -->
	<script type="text/javascript" src="../../js/analytics.js"></script>

	<!-- Gif player -->
	<link rel="stylesheet" type="text/css"href="../../css/freezeframe_styles.scss">

	<style>
	.etech-sch-col1 {width:60px; border: 1px solid black;padding:10px;}
	.etech-sch-col2 {width:120px; border: 1px solid black;padding:10px;}
	.etech-sch-col3 {width:450px; border: 1px solid black;padding:10px;}
	.etech-sch-col4 {width:70px; border: 1px solid black;padding:10px;}
  .etech-sch-col5 {width:70px; border: 1px solid black;padding:10px;}
  /*.etech-sch-col6 {width:170px; border: 1px solid black;padding:10px;}*/
  ul {
    padding:0px;padding-left:10px;margin:0px;
  }
	</style>
</head>

<body>
<header class="main_header">
	<!-- to be filled by javascript, see header.html -->
</header>

<!--script src="//code.jquery.com/jquery.min.js"></script-->
<!--script src="../../js/freezeframe.js"></script-->
<script src="../../js/freezeframe.min.js"></script>
<script src="../../js/freezeframebutton.js"></script>

<section class="main_container">
	<div class="container">
    <div class="row nothing">

      <section class="col-md-8 pull-right main-content">
</br></br></br></br>
        <h4 class="medium.headline"><a href="6810-engineering-interactive-technologies.html">6.810 Engineering Interactive Technologies (fall 2021)</a><br></h>
        <h2 class="headline">Pset2: Assembling the Multi-Touch Pad and Circuit</h2>

In this problem set, you will print out your multi-touch pad on the conductive inkjet printer and assemble the top and bottom layer. After this, you will build the touch-sensing circuit and connect your multi-touch pad to it. As part of building the circuit, you will also have to solder some header pins to some of the components first. At the end of this problem set, you will download a piece of test code that will verify that the assembled multi-touch pad and the corresponding circuit is correct, i.e. the test code will verify that your hardware can sense touch data from a user's finger.<br><br>

<b>Steps:</b>
<ol>
	<li><a href="#PRINT">Inkjet Print Top and Bottom Electrode Layers</a></li>
	<li><a href="#ELECTRODETEST">Confirm Electrodes are Conductive and No Crosstalk</a></li>
	<li><a href="GLUE">Glue Together Top and Bottom Electrode Layers</a></li>
	<li><a href="#LAMINATE">Laminate the Assembled Multi-Touch Pad</a></li>
	<li><a href="#FPC">Solder FPC Connectors</a></li>
	<li><a href="#CONNECTFPC">Connect FPC Connectors to Multi-Touch Pad</a></li>
	<li><a href="#SOLDERMULTIPLEXER">Solder Multiplexer</a></li>
	<li><a href="#SENDING">Build Sending Circuit</a></li>
	<li><a href="#RECEIVING">Build Receiving Circuit</a></li>
	<li><a href="#TESTRUN">Testing your Circuit</a></li>	
</ol>

 <div style="color:black; border: black 1px solid; padding: 20px;margin-bottom:20px;">
<b>Help us Improve Class Materials for PSet2:</b><br>
Please let us know if anything was confusing in the write up or if you had trouble with the test program. <br> <a href="https://docs.google.com/document/d/1RRaa5aSC7HWwmADo06eyMa9aDeZ9IokwW7t47hOEbFQ/edit?usp=sharing">You can add your comments here.</a></div>

 <div style="color:black; border: black 1px solid; padding: 20px;margin-bottom:20px;">
<b>Ask a TA to give you the fabrication files (.pdfs) if something went wrong in pset1</b><br>
In case you did not finish pset1, you can ask a TA to provide you with the fabrication files (i.e., the two pdfs for the top and bottom electrode layers) so you can continue pset2. If you finished pset1, but upon review by the teaching team, it turns out that your fabrication files have a problem that cannot be easily fixed, you can also ask a TA to give you the fabrication files.</div>

<h3 id="PRINT">(1) Inkjet Print Top and Bottom Electrode Layers</h3>

<b>Inkjet Print:</b> Once the TAs have verified the two fabrication files (.pdfs) you generated in pset1, you can print them out. Ask a TA to give you the two transparent sheets (one for the columns and one for the rows) you need for printing.<br><br>


<b>Find out which side of the transparent sheet to print on:</b> Only one side of the transparent sheet has the coating that makes the silver ink conductive, so you have to make sure you use the correct side. Use a drop of water on a corner of the sheet. You will notice one side will turn a bit white and the other will have no change. The white side is the one we want to print the silver on and it should be facing up when you insert it into the printer.<br><br>

<img src="images/pset2/print_side_new.gif" width="370px" style="cursor:pointer;"> 
<img src="images/pset2/insert_transparent_sheet.gif" width="370px" style="cursor:pointer;"> <br><br>

<b>Print Settings:</b> The rest of the printing is the same as in lab. If you don't remember how to print, <a href="./how-to-print.html" target="_blank">you can find information here</a>.<br><br>


<h3 id="ELECTRODETEST">(2) Confirm Electrodes are Conductive and No Crosstalk</h3>


<b>Check conductivity of printed electrodes:</b> Test each electrode line with a multimeter to see if the print is conductive enough before assembling the top and bottom electrode layers. Sometimes during printing not enough silver ink comes out (e.g., because of clogged print nozzles) and the resulting print is not conductive enough. To test this, take the multimeter and hold one probe to the leftmost electrode and the other probe to the rightmost electrode. If you see that the resistance reading is less than 300 ohms, there is no issue. You can also test each electrode pair individually and you should see that electrodes closer together will have less resistance between them than electrodes further apart since resistance builds up over the length of the wire.
<br><br>

<iframe width="600" height="360" src="https://www.youtube.com/embed/-MoEOHQVPco" title="YouTube video player" frameborder="0" allowfullscreen></iframe><br><br>

<b>Check crosstalk between adjacent rows/columns of printed electrode:</b>
Test that there is no connection between adjacent rows/columns using a multimeter. If there is no cross-talk, there will be more than a megaohm resistance between adjacent rows/columns.
<br><br>

<iframe width="600" height="360" src="https://www.youtube.com/embed/43w-7eKoK9s" title="YouTube video player" frameborder="0" allowfullscreen></iframe><br><br>

<h3 id="GLUE">(3) Glue Together Top and Bottom Electrode Layers</h3>

<b>Assemble:</b> To assemble both sheets together, please ask a TA to help you with this either in lab or in an OH.<br><br> 

<b>Conductive side of both sheets should face upwards:</b> First, check that both of your sheets have the conductive side facing upwards.<br><br>

<b>Stack and Align both electrode sheets:</b> Next, stack your electrode sheets on top of each other and align them precisely. The alignment between the top and bottom electrodes is critical for receiving an accurate sensing signal.<br><br>

<b>Attach tape to maintain alignment:</b> To help maintain the relative alignment, tape the two sheets together on one side using regular scotch tape.<br><br>

<b>Flip top sheet over:</b> Flip the top layer up, so that the bottom layer is exposed.<br><br>

<img src="images/pset2/pset1-scotch-tape.png" width="800px" style="cursor:pointer;"> <br><br>

<b>Glueing with tape vs. tattoo transfer paper:</b> While you could use simple double-sided transparent tape for glueing the sheets together, the tape has a certain thickness to it. This is a problem because more space between the electrode layers results in worse sensing. The electrodes are already spaced out by the thickness of the sheet on which they were printed, so the tape would add even more thickness. To keep the glue layer as thin as possible, you will instead use the <a href="https://www.amazon.com/gp/product/B0043WJ3OA/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&psc=1" target="_blank">adhesive of temporary transfer paper</a>.<br><br>

<b>Using the tattoo transfer paper to glue the top and bottom sheets together:</b> Ask a TA to give you the tattoo transfer paper and help you with this step. Pull off the protective cover from one side of the tattoo transfer paper, then attach the now exposed sticky side of the tattoo transfer paper to the bottom electrode sheet to cover all the electrodes (no need to cover the wires). Next, remove the second protective cover from the other side of the tattoo transfer paper to reveal the second sticky side. Now flip back the top electrode layer to make everything sticks together (check your electrode alignment one more time before you do this).<br><br>

<img src="images/pset2/pset1-tatto-paper.png" width="600px" style="cursor:pointer;"> <br><br>


<h3 id="LAMINATE">(4) Laminate the Assembled Multi-Touch Pad</h3>

Now that both layers are glued together, the next step is to laminate your multi-touch pad. This has two purposes. First, since the conductive side of the top sheet is facing towards the user, the silver of the top electrodes is still exposed, and you need to cover it up to prevent the user from touching it directly. Second, lamination helps with durability of the multi-touch pad.<br><br>

<b>Leave end of Wires Exposed:</b> We will give you two lamination sheets that you can use to sandwich your multi-touch pad. When you sandwich your multi-touch pad between the lamination sheets, make sure you leave the end of the wires exposed that will later connect to the FPC connector. You can use the lamination device in lab or in an OH. (Below it looks like we already cut out the multi-touch pad, no need to do this at this point, you will do it later in this pset).<br><br>

<img src="images/pset2/lamination.png" height="340" style="cursor:pointer;">
<img src="images/pset2/lamination.gif" height="340" style="cursor:pointer;">
<br><br>

<h3 id="FPC">(5) Solder FPC Connectors</h3>

Once you have the multi-touch pad printed and assembled, you need to connect its inkjet printed wires to a breadboard so it can work with the rest of the circuit.<br><br> 

<b>FPC connectors:</b> In the labs, we used crocodile clamps to connect our inkjet printed circuit to a breadboard but for the multi-touch pad, the wire spacing is so tight that crocodile clamps will not work. A component that is more suitable for our purposes is a Flexible Printed Circuit (FPC) Connector. The FPC connector has high resolution connectors on one side, which we will use to connect to the inkjet printed circuit, and on the other side has more widely spaced connectors, which we can use to connect to our breadboard. We bought these <a href="https://www.amazon.com/gp/product/B07VCJG54G/ref=ppx_yo_dt_b_asin_title_o00_s00?ie=UTF8&psc=1" target="_blank">FPC connectors here</a>.<br><br>  

<b>Soldering header pins onto the FPC connectors:</b> You have two FPC connectors, one for the top and another for the bottom electrodes. Since they don't have the header pins on them yet, you need to solder them on yourself. You have some header pins in your fabrication bag. Use the method in the video below to ensure your pins will be straight after soldering.<br><br>
<table BORDER=0 CELLPADDING=0 CELLSPACING=0>
	<tr>
		<td rowspan="2"><img class="freezeframebutton" src="images/pset2/how_to_solder.gif" height="362px" style="cursor:pointer;"></td>
		<td><img src="images/pset2/fpc-without-headers.jpg" width="210px" style="cursor:pointer;"></td>
	</tr>
	<tr>
		<td><img src="images/pset2/fpc-with-headers.jpg" width="210px" style="cursor:pointer;"></td>
	</tr>
</table>
<!--<img src="images/pset2/headerpins.png" width="170px">-->
<br><br>

<b>Testing if each pin on your FPC chip is soldered:</b> You can use a multimeter to test if each pin on the FPC chip is correctly soldered. If you examine the top layout of the FPC chip closely, you can see that it shows you its wire layout, i.e. how each pin on one side of the FPC connector is connected to the other side (see image on the left). Place one tip of the probe on the soldered header pin and the other probe on the wire on top of the chip (see video on the right). If the header pin was soldered properly, the multimeter will beep, which means there is a connection. <br><br>

<table><tr><td>
<img src="images/pset2/trace_fpc.png" width="330px" ="140px" style="cursor:pointer;"></td>
<td><iframe width="450" height="270" src="https://www.youtube.com/embed/YQoJ_9FC77E" title="YouTube video player" frameborder="0" allowfullscreen></iframe></td>
</tr>
</table>
<br>

<h3 id="CONNECTFPC">(6) Connect FPC Connectors to Multi-Touch Pad</h3>

<b>Cut out the area around multi-touch wires for FPC connection:</b> Before you can connect your FPC connector to the multi-touch pad, you will need to cut out some free space around the end of the wires on your multi-touch pad. When you cut out the area for the connector, pay extra attention to ensure that it will fit inside the FPC connector; the little pins inside the FPC connector head should align precisely with the wires of your multi-touch pad, otherwise there is either no connection or a very fragile connection.<br><br>

<img src="images/pset2/aligning-inkjet-print-with-fpc.jpg" width="390px" style="cursor:pointer;">
<img src="images/pset2/fpc-connector-slot.jpg" width="330px" style="cursor:pointer;"><br><br>

<b>Connecting the FPC connectors to the wires of the multi-touch pad:</b> Once you soldered your FPC connector and cut out the wires on the multi-touch pad, you are ready to connect the FPC to your multi-touch pad. Make sure the conductive side of the multi-touch pad, i.e. the silver traces, are facing towards the breakout board of the FPC (i.e. where you just tested for conductivity). Pull out the little tab on the FPC connector, insert the wires, then push the little tab back in to secure the wires. Once you are done connecting one side of the multi-touch pad, repeat the procedure for the other side to connect the second FPC connector.<br><br>

<img src="images/pset2/FPC_open_connect_close.png" width="800px" style="cursor:pointer;"><br><br>

<!-- <b>(2) Flip-up:</b> <br> -->
<!-- <img src="images/pset2/pset1-fpc-connector_1.jpg" width="330px"><br><br> -->

<b>Testing if your FPC chip makes a connection to each wire from the multi-touch pad:</b> You can use a multimeter to test if each pin on the FPC connector is properly connected to each of the Multi-touch pad wires. First, check one more time that each of your wires is conductive by sampling two points on the wire and checking that it shows < 300 ohms. Once you are sured your wires are still conductive, check the wire-to-FPC connection by sampling one point on the wire and the other on the FPC header pin.<br><br>

<iframe width="600" height="360" src="https://www.youtube.com/embed/bJtLXKXzuwc" title="YouTube video player" frameborder="0" allowfullscreen></iframe><br><br>


<b>Disconnecting/Reconnecting the Multi-Touch pad from Circuit:</b> For the future, when you store your multi-touch pad and need to disconnect it from the main circuit, make sure you do not disconnect the FPC connector from the inkjet printed multi-touch wires. Unclipping and reclipping the FPC from the inkjet printed traces repeatedly will break the silver traces, so it's better to not do this at all. Instead, only unplug the jumper wires from the header pins of the FPC connector and leave the FPC connector connected to the multi-touch pad at all times.
<br><br>

<img src="images/pset2/plug_unplug.png" width="500px" style="cursor:pointer;"><br><br>

<h3 id="SOLDERMULTIPLEXER">(7) Solder the Multiplexer for the Sending Circuit</h3>

Before you can build the sending circuit, you need to solder header pins onto the multiplexer (we will explain in a minute what the multiplexer is for). A multiplexer is also sometimes call 'Mux' for short.<br><br>

<b>Soldering header pins onto the multiplexer:</b> The multiplexer we bought has no header pins attached yet, so you need to solder them on. You have some header pins in your fabrication bag. Make sure you solder on the pins straight using the method shown below, otherwise you multiplexer will not fit into a breadboard. <br><br>

<img src="images/pset2/mux_soldering.png" height="300px" style="cursor:pointer;"> 
<br><br>

<b>Testing if each pin on your multiplexer is soldered:</b> You can use a multimeter to test if each pin on the multiplexer is correctly soldered. Similar to the FPC chip, you can see that the multiplexer shows its wire traces on the board. Place the tip of one probe on the soldered header pin, and the other probe on the leg of the chip at the end of the trace that starts at the corresponding soldered header pin. If the header pin was soldered properly, the multimeter will beep, which means there's continuity. <br><br>

<table>
	<tr>
		<td>
<img src="images/pset2/trace.png" width="300" style="cursor:pointer;"></td>
<td>
	<iframe width="470" height="280" src="https://www.youtube.com/embed/va-0KGMV0OU" title="YouTube video player" frameborder="0" allowfullscreen></iframe>
	</td>
</tr>
</table>
<br><br>


<h3 id="SENDING">(8) Build Sending Circuit</h3>

Before we build the sending circuit, let's briefly recap how the multi-touch pad will work.<br><br>

<b>Multi-Touch Pad Working Principle:</b> As mentioned in lecture, the multitouch pad consists of sender electrodes (e.g., columns) and receiver electrodes (e.g., rows). A signal is injected into the sender electrodes and the receiver electrodes then pick up the signal and any modulation to it that occured due to a user's finger. The sending circuit injects a PWM signal into the sender electrodes. When powered, the multitouch pad sends a PWM signal to each of the sender electrode columns one by one, i.e. first sends the PWM signal to the first sender electrode column, then the second, then the third and so on. After it reaches the last sender electrode column, it restarts from the first. <br><br> 

<img src="images/pset2/multitouch-schematic-sending.png" width="600px" style="cursor:pointer;"> <br><br>

<b>Number of Sender Pins:</b> Since we need to send a PWM signal to each column of electrodes individually one after another, sharing a single PWM sender pin like we did in lab does not work since it would send a signal to all electrodes simultaenously. To send a PWM signal one by one to each column, we need as many sender pins as we have columns. While we have enough GPIO/PWM pins on the ESP for our 8x9 Multi-touch pad (i.e. 17 in total, 8 for receiving and 9 for sending), we would quickly run out of pins if we used a multi-touch pad with a higher resolution. We, thus, want to introduce a new component: a multiplexer, that allows you to scale up the number of pins you have available while reducing the number of ESP pins needed to send the signals.<br><br>

<b>Using a Multiplexer to Scale up the Number of Sender Pins:</b> A multiplexer can take one single input and direct it to multiple outputs (de-multiplexing). Thus, for sending, we can use a single pin on the ESP to generate the PWM signal and then pipe the signal through the multiplexer, which can direct it to the individual electrode column that the signal should be applied. We bought the following <a href="https://www.amazon.com/gp/product/B07K7JF3HX/ref=ppx_od_dt_b_asin_title_s00?ie=UTF8&psc=1" target="_blank">multiplexer from here.</a> You can find the <a href="https://www.ti.com/lit/ds/symlink/cd74hc4067.pdf?ts=1598252309140&ref_url=https%253A%252F%252Fwww.google.com%252F" target="_blank">datasheet here</a> and <a href="http://cdn.sparkfun.com/datasheets/BreakoutBoards/Analog-Digital-Mux-Breakout-v11.pdf" target="_blank"> the schematic file here</a>.<br><br>  

<img src="images/pset2/demux-labeled.png" width="400px" style="cursor:pointer;"> <br><br>

<b>Breadboard use:</b> Before you start wiring, we recommend strategizing about how you want to layout your breadboards. We recommend to put the two breadboards that have the ESP on it in the middle and then put one more breadboard to the right of the ESP (this can hold the circuit for the sending circuit with the multiplexer) and one more breadboard to the left of the ESP (this can hold the receiving circuit with the ADC chip, as described in section #9).<br><br>

<img src="images/pset2/breadboarding.png" height="350px" style="cursor:pointer;"> <br><br>

<b>Connecting the Multiplexer to the ESP and FPC:</b> Let's build the multiplexer sending circuit.<br>

<i>Providing the Input Signal from the ESP (SIG):</i> First, let's start by providing our multiplexer with the input signal from the ESP. For this, connect the signal pin (SIG) on the multiplexer to <code>GPIO16 pin on the ESP</code> (any GPIO pin would work but we ask you to use the pin numbers we specify which will make debugging your code in the later psets easier).<br><br>

<img src="images/pset2/multiplexer.png" height="350px" style="cursor:pointer;"> <br><br>

<i>Connecting the output channels to the electrode columns (C0-C8):</i> If you look at your multiplexer, you will see that it has 16 output channels (pins on the left side, C0-C15). We want to connect each output channel to one column of our multi-touch pad (we don't need all 16 channels since our multi-touch pad only has 9 columns). We will use <code>channels C0 through C8</code>. We can then use the multiplexer to redirect the input signal from the SIG pin to one of the channels, thereby injecting the signal into a specific column of the multi-touch pad. Connect each of your electrode colunmns to one of the pins using male-to-female jumper wires from the FPC to a breadboard.<br><br>

<i>Selecting which Channel to send the Signal to (S0-S3):</i> How do we tell the multiplexer which channel <code>C0-8</code> our input signal <code>SIG</code> should be directed to, i.e. how can we tell the multiplexer to send the input signal to, say, the C6 output pin? We do this by providing the multiplexer with a 4-bit, binary enconding of our desired output through the four pins on the right side, labeled <code>S0-S3</code>. Why four pins? The multiplexer expects a binary signal, e.g. sending 0,0,0,0 to S0-S3 directs the output to pin C0, whereas sending 0,1,1,0 to S0-S3 directs the output to pin C6. Thus, by using the multiplexer we can send a signal to up to 16 electrode columns (C0-C15) using only 5 pins (SIG + S0,S1,S2,S3) on the ESP rather than 16 pins! Wire up the S0-S3 pins to <code>GPIO19, GPIO18, GPIO5, GPIO17 pin</code> on the ESP. Again, though any GPIO pins on the ESP can be used, we specified the following pins so that we can easily swop out your code for our code in later psets for debugging purposes.<br><br>

<i>Powering the Multiplexer:</i> Finally, connect the power VCC and GND pins on the multiplexer to the corresponding pins on the ESP to power the multiplexer.<br><br>


<h3 id="RECEIVING">(9) Build Receiving Circuit</h3>

As you can see in the schematic, the circuit for receiving is very similar to what we have done in lab. Each touch-sensing row is connected to its own resistor and then connected to an ADC/TOUCH pin on the microcontroller.<br><br> 

<img src="images/pset2/multitouch-schematic-receiving.png" width="600px" style="cursor:pointer;"> <br><br>

<b>Using a separate ADC component:</b> Unfortunately, the ADC/TOUCH pins on the ESP32 are not reliable enough for our purposes, i.e. they do not output clean signals for our multi-touch pad. We will use a separate ADC component in place of the ADC pins on the ESP32. The component we use is the <a href="https://www.adafruit.com/product/856" target="_blank">MCP3008</a> chip, and you can find <a href="https://cdn-shop.adafruit.com/datasheets/MCP3008.pdf" target="_blank">its datasheet here</a>.<br><br>

<img src="images/pset3/adc-pin-chip.png" width="250px" style="cursor:pointer;"><br><br>

<b>Connecting the Receiving Electrodes to the ADC component:</b> Let's first connect the receiving electrodes from our multi-touch pad to the ADC component by connecting them to channels <code>CH0 - CH7</code> (see the component image below). Don't forget to add the <code>100kOhm resistor</code> to each electrode row.<br><br>

<b>Powering the ADC component:</b> Next, power the ADC component by connecting the <code>Vdd pin</code> to 3.3V and the <code>Dgnd pin</code> to GND.<br><br>

<b>Reference Signal:</b> The MCP3008 chip also needs a reference voltage to calculate the unknown voltage from the incoming CH0-7 pins (ADC conversion). This reference voltage needs to be less than or equal to the operating voltage of the ADC component. Since we use 3.3V on Vdd, you can connect the <code>reference voltage pin VRef</code> to 3.3V as well, and then connect the <code>AGND pin</code> to ground.<br><br>

<img src="images/pset2/mpc-pin-out-labeled.png" width="480px" style="cursor:pointer;">
<img src="images/pset2/spi-labeled.png" width="260px" style="cursor:pointer;"> 
 <br><br>

<b>Connecting the ADC component to the ESP:</b> Sending data from the ADC component to the ESP is a little more complicated. The MCP3008 chip communicates with the ESP via a Serial Peripheral Interface (SPI). We use basic SPI between one master (ESP) and one slave (MCP3008 chip). SPI communication is setup via 4 types of pins, i.e. MOSI is the line for the master to send data to the slave, MISO is the line for the slave to send data to the master, SCK is the line for the clock signal that determines how fast bits of data can be sent, and NSS/CS is a line for the master to select which slave to send data to. The ADC chip uses different names on its pinout for these pins, i.e. <code>MOSI (DIn), MISO (DOut), SCK (CLK), and NSS/CS (CS/SHDN)</code> as shown above in the MPC chip pinout. The ESP uses the regular names as shown on the ESP pinout below. Wire up these four SPI pins (not VSPI) between the ADC chip and the ESP. <br><br>

<img src="images/pset3/esp32-pinout.png" width="800px" style="cursor:pointer;"><br><br>
<!-- <b>**** Important Notes **** <br>
	1) GPIO 34-39 are INPUT only <br> 
	2) do not use GPIO 0 as INPUT <br>
	3) try to avoid GPIO 6-11, which might have unexpected behaviors </b><br><br>
 --><!--<img src="images/pset2/adc_fritzing_label.png" width="900px">-->

<b>Using a Multiplexer for the receiving circuit:</b> While we will not do it in this pset, we could also use a second multiplexer to reduce the number of pins required for the receiving circuit, i.e. the electrode rows. When using the multiplexer for receiving, we would redirect the received signal on C0-C15 to the SIG pin that is then read by the ESP. Similar to above, we would only have to specify which channel (C0-C15) we want to read and the ESP would then retrieve the signal from the respective channel. Thus, this second multiplexer would reduce the number of receiver pins by combining multiple rows into one pin on the ESP.<br><br>

<h3 id="TESTRUN">(10) Testing your Circuit</h3>

Now that you build your circuit, it would be good to know if it actually works. To help you test your circuit, we compiled a test program as a binary that you will upload to your microcontroller. This is different from uploading a regular .ino file, and we will describe the steps for you below.<br><br>

<b>Update Arduino IDE 'Preferences':</b> Open the Arduino IDE and go to <code>Arduino -> Preferences</code>. In the window that opens, where is says <code>Show Verbose Output During</code> check both the <code>compilation</code> and the <code>upload</code> checkbox. In addition, further down check the <code>Display line numbers</code> checkbox. Then click 'ok'.<br><br>

<img src="images/pset2/arduino-ide-preferences.png" width="550px"><br><br>

<b>Make sure your Microcontroller is plugged in:</b> <span style="color:red">Before you continue, make sure your microcontroller is connected to your laptop via the USB cable. (Stefanie: I added this here, not sure if really true.)</span> <br><br>

<b>Retrieve the Compile and Upload Command:</b> Compile and upload a random program in the Arduino IDE (e.g. choose the Blink program from the examples) and look at the compile path in the console window (the white text). Copy the entire last line in white text into a textfile. See the marked line down below. <br>

<img src="images/pset2/compile-path.png" width="750px"><br><br>

<b>Find the File Path for the Binary File:</b> Next, you need to find the file path of the binary program that we provide to you. You can <a href="">download the <span style="color:red">'pset2-standaloneXX'</span> from here</a>. Right click the file after you downloaded it and click 'Get Info'. Under <code>Where</code> you can find its file path. Copy this part and save it in a text file as well.<br><br>

<img src="images/pset2/file-info.png" width="250px"><br><br>

<b>Replace File Path in Compile Pat:</b> Replace the file path of your binary in the compile/upload command (i.e. the white text you had copied into a text file). You need to replace the two binary file (.bin) path in two locations in the text.<br><br>

<img src="images/pset2/replaced-file-path.png" width="750px"><br><br>

<b>Execute Command on Terminal:</b> Now that your command is complete, you can paste it into the terminal of your operating system and execute it. If everything is correct, you will see on the terminal that the program is uploading. Once it is uploaded you will see <span style="color:red">XX if your circuit is working and YY if your circuit is not working.</span> <span style="color:red">Junyi, can you add an image here that shows working vs. not working?</span> If it is not working, we recommend you do the following things: XX and YY<br><br>


<h3>Final check before you submit/upload</h3>
Before you submit files, please check the following:
<ul>
	<li>You should have an assembled laminated multi-touch pad, a sending circuit, and a receiving circuit.</li>
	<li>The multi-touch pad, sending circuit, and receiving circuit should be wired.</li>
	<li>Check the soldering condition of the two FPC connectors.</li>
	<li>Check the connection between the FPC connector and the wires of the Multi-touch pad.</li>
	<li>Check the soldering condition of the multiplexer.</li>
	<li>The test program should have successfully executed.</li>
</ul>


<h3>Upload Circuit Photos + Show Hardware to a TA</h3>

For grading, please upload the following to your google drive student folder:<br>

<ul>
	<li>3-5 photos showing your assembled circuit and laminated multi-touch pad from different perspectives (include top view + side views)</li>
	<li>bring your multi-touch pad to the next lab or to an OH to have all its solder and FPC connections tested and graded by a TA</li>

	<!-- <li><span style="color:red">bring your assembled multi-touch pad to your spray session</span></li> -->
</ul>

<h3>Grading</h3>

We will give 20 pts in total:
<ul>
	<li>5pts: Did you finish assembling your printed multi-touch pad, i.e. did you inkjet print both the top and bottom electrode layers, checked that your print is conductive, glued both layers together, and laminated them?</li>
	<li>5pts: Did you solder the FPC connectors and connected the FPCs correctly to the multi-touch pad? Did you solder your multiplexer?</li>
	<li>5pts: Did you correctly build the sending circuit with the multiplexer?</li>
	<li>5pts: Did you correctly build the receiving circuit with the ADC chip?</li>
</ul>



<!-- Footnote 1: Unfortunately, the ESP32 ADC/TOUCH pins are only reliable in the middle of the ESP's voltage range (~0.5V to maybe 3.0V) but not at the lower and upper ends of the range. Our touch sensing circuit functions at the lower range. Even worse, because our circuit (receiver pins) outputs between -0.6V and 1.2V (yes that is a minus), we end up with negative voltages on the ADC pins, which are completely out of the spec of the ESP32's ADC inputs and would create a signal that is non-linear and would require a lot of calibration. The reason we can have negative voltages is because we are practically generating a high-frequency AC signal with the PWM. This creates capacitive coupling between the breadboard channels and wires. To make the ESP ADC pins work with negative voltages, you could add rectification circuits and amplifiers before having the signal go into the ADC pin, but that is quite some extra effort. For our purposes, it is therefore easier to not use the ESP ADC pins and instead use another ADC component that can work well within the Voltage range we use for the multi-touch pad.<br><br>
 -->


        <br />
      </section>

      <aside class="col-md-4 pull-left">
         <br /> <br /> <br /> <br /><br>

                 <h4 class="medium.headline" style="padding-bottom:10px;"><a href="pset-multi-touch-pad.html"><b>Pset Series: Multi-Touch Pad</b></a><br></h4>

<ul>
          <li><a href="pset1-circuit-design.html">Pset1: Generating the Fabrication Files</a></li>
          <li><a href="pset2-multitouch-assembly.html">Pset2: Assembling the Circuit</a></li>
          <li><a href="pset3-signal-processing.html">Pset3: Sensing Multi-Touch Input</a></li>
          <li><a href="pset4-visualization.html">Pset4: Visualizing Multi-Touch Input</a></li>
          <li><a href="pset5-multitouch-application.html">Pset5: Gesture Detection</a><br></li>
</ul><br>


<img src="images/pset-multi-touch-pad/pset-processing1.png" width="350px">
<br><br>

In this pset series, you will create an inkjet printed multi-touch pad. You will first write a Processing program that automatically generates the fabrication files for the multi-touch pad. Next, you will print your multi-touch pad, assemble it, and then build the circuit for sensing touch input. You will then write the microcontroller code for reading the touch signals from each electrode. Next, you will extend your code to draw the touch signals into an image and then extract the touch points via computer vision. Finally, you will write a gesture recognizer that can differentiate between different user inputs.<br><br>

</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>

      </aside>

    </div>
  </div>
  </div>
</section>

<div class="container">
	<div class="row">
		<div class="col-md-12 footer" style="text-align: center;">
			<span class="copyright">
			Since 2017 &copy; MIT CSAIL (HCI Engineering group) [redesign by
			<a href="http://punpongsanon.info/" target="_blank" style="text-decoration:none; border-bottom:0px">
			moji
			</a>].
			All Rights Reserved.

			<a href="http://mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/mit.svg" alt="MIT" class="footer-logo" />
			</a>
			<a href="http://csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/csail.svg" alt="CSAIL" class="footer-logo"/>
			</a>
			<a href="http://hci.csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/hci.svg" alt="HCI" class="footer-logo"/>
			</a>
			</span>
		</div>
	</div>
</div>

<!-- Bootstrap -->
<script type="text/javascript" src="../../js/bootstrap.min.js"></script>
<!-- header -->
<script type="text/javascript" src="../../js/headerstrap-for-subpage.js"></script>

</body>

<!-- popup image in new window when click it-->
<script type="text/javascript">
	var img = document.getElementsByTagName("img");
		for (var x = 0; x < img.length; x++) {
			img.item(x).onclick=function() {window.open(this.src)}; 
		}
</script>

</html>