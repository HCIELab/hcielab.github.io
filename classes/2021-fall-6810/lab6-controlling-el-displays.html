<!DOCTYPE html>
<html>
<head>
	<title>HCI Engineering Group</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

	<!-- CSAIL ICON -->
	<link rel="CSAIL" href="../../../images/icon/csail.ico" type="image/x-icon" />

	<!-- Bootstrap -->
	<link href="../../css/bootstrap.css" rel="stylesheet">
	<link href="../../css/custom-style.css" rel="stylesheet">

	<!-- jQuery -->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Abel" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Barlow" rel="stylesheet">

	<!-- Google Analytic -->
	<script type="text/javascript" src="../../js/analytics.js"></script>

	<style>
	.etech-sch-col1 {width:60px; border: 1px solid black;padding:10px;}
	.etech-sch-col2 {width:120px; border: 1px solid black;padding:10px;}
	.etech-sch-col3 {width:450px; border: 1px solid black;padding:10px;}
	.etech-sch-col4 {width:70px; border: 1px solid black;padding:10px;}
  .etech-sch-col5 {width:70px; border: 1px solid black;padding:10px;}
  /*.etech-sch-col6 {width:170px; border: 1px solid black;padding:10px;}*/
  ul {
    padding:0px;padding-left:10px;margin:0px;
  }
	</style>
</head>

<body>
<header class="main_header">
	<!-- to be filled by javascript, see header.html -->
</header>

<section class="main_container">
	<div class="container">
    <div class="row nothing">

      <section class="col-md-8 pull-right main-content">
</br></br></br></br>
        <h4 class="medium.headline"><a href="6810-engineering-interactive-technologies.html">6.810 Engineering Interactive Technologies (fall 2021)</a><br></h>
        <h2 class="headline">Lab 6: Controlling Electroluminescent Displays</h2>
      
    In this lab, you will create the control circuit for your electrolumiscent display so that you can turn on/off the display and even dim it to a specific brightness using your ESP microcontroller.<br><br>

    <span style="color:red">can we have some nice images here or a video showing the display dimming?</span><br>

<img src="images/lab6/battery-holder.png" width="480px">
<img src="images//lab3/displayconnected.jpg" width="252px"><br>

<h3>Steps:</h3>
<ol>
  <li><a href="#XXXX">Safety Instructions</a></li>
  <li><a href="#XXXX">Connect Inverter Output to EL Display</a></li>
  <li><a href="#XXXX">Connect Inverter Input to Battery</a></li>
  <li><a href="#XXXX">Power up Your Display</a></li>
  <li><a href="#XXXX">XXXX</a></li>
  <li><a href="#XXXX">XXXX</a></li>
  <li><a href="#XXXX">XXXX</a></li>
  <li><a href="#XXXX">XXXX</a></li>
</ol>


<h3>Deliverables</h3>

At the end of the lab, upload to your student google drive:
<ol>
  <li>the Arduino code (.ino) for dimming your display</li>
  <li>2-3 photos (.jpg or .png) from different angles of your circuit</li>
  <li>a short video (.mov or .mp4, max. 1 minute) showing how you display dims and performs a full cycle from bright to dark and dark to bright again</li>
</ol><br>

 <h3 id="XX">(1) Safety Instructions</h3>

In this tutorial, we will generate 50V AC from a 1.2V AA battery using an inverter. 50V AC is the maximum allowed voltage for class activities. You are not allowed to use the inverter with anything else than the 1.2V AA battery we provide for you. Our 50V AC are low current and not dangerous, but you will feel a sensation at the tips of your fingers when touching the circuit. Therefore, never plug the display in while you are working on the circuit and you are touching the wires!<br><br>

While building your circuit, you must adhere to the following rules:
<ul>
  <li>unplug the battery <b>before</b> you do any wiring, only after it is unplugged you are allowed to touch the circuit and exchange wires and components</li>
  <li>once you are done wiring and you have made sure you are not touching any part of the circuit anymore, plug the battery back in</li>
  <li>never touch the display or any part of the circuit while the battery is plugged in, i.e. the circuit is powered</li>
</ul> 
<br>

<span style="color:red">add images showing somebody unplugging, wiring, pluggin.</span><br>
<img src="images/lab6/battery-holder.png" width="590px"><br><br>


 <h3 id="XX">(2) Connect Inverter Output to EL Display</h3>

<b>AC vs. DC current:</b> EL displays require an alternating current between the two elecrodes to excite the phosphor and make it light up. Therefore, just connecting it to a DC power supply, like the 3.3V DC from your ESP32, won't do the trick. We therefore use an inverter to generate AC current from DC.<br><br>

<b>Add Jumper Wires to Inverter Output:</b> Before you do anything, remove the battery from your battery holder to remove all power from the circuit. The inverter output is the black/black cable. Take two jumper wires and stick them into the white connector of the interverter output.<br><br>

<b>Crocodile Clamp to Display Bottom Layer (copper layer with copper tape flap):</b> Next, use a crocodile clamp to connect the first inverter output to the copper side of the display. One end of the crocodile clamp goes onto the jumper wire, the other goes onto the little copper flap. Be careful that you don't rip of the copper flap while working with the wires.<br><br>

<b>Crocodile Clamp to Display Top Layer (ITO with copper tape):</b> Next, use a second crocodile clamp to connect the other inverter output to the top layer of the display, i.e. the ITO. One end of the crocodile clamp goes on the jumper wire, the other goes onto the ITO sheet where there is  copper tape.<br><br>

<span style="color:red">can we replace the middle image? the display is not yet supposed to be on.</span><br>
<img src="images/lab6/wiring-interverter-output.png" width="750px"><br><br>


 <h3 id="XX">(3) Connect Inverter Input to Battery</h3>

<b>Add Jumper Wires to Inverter Input:</b> The inverter input is the black/red cable. Take two jumper wires and stick them into the white connector of the interverter input.<br><br>

<b>Crocodile Clamp to + pol of Battery Holder:</b> Before you do this, make sure the battery is still removed and not in the holder. Use a crocodile clamp to connect the red wire to the + pol of your battery holder.<br><br>

<b>Crocodile Clamp to - pol of Battery Holder:</b> Use another crocodile clamp to connect black to -.<br><br>

<span style="color:red">can we have an image here with wiring as described but without battery?</span><br><br>

 <h3 id="XX">(4) Power up Your Display</h3>

<b>Flip Display:</b> Once you are done wiring, turn the display around such that you see the top side. The copper should be on the bottom now and you can't see it anymore. <br><br>

<b>Insert AA Battery (do not touch the circuit anymore):</b> Before you insert the battery, make sure you are not touching the circuit anymore at any place, do not touch the display. Then insert the AA battery into the battery holder. You should see a bright EL display in the shape of the coffee mug now. <br><br>

<b>Debugging the Display:</b> If your display does not light up, remove the battery, then check if all wires are connected properly. Before you reinsert the battery, remember you should not touch the circuit or display.<br><br>
    
<img src="images/lab6/displayconnected-cropped.jpg" width="450px"><br><br>


<h3 id="XX">(5) Build Control Circuit for Display</h3>


Now you can turn on/off your display by plugging and unplugging the battery.<br> 
That's ok but it would be nicer to do this via code and not by physically plugging/unplugging the battery.<br>
The goal of this final part of the lab is to build a control circuit that lets you do exactly this. <br><br>

<b>Switch to Turn On/Off Display</b><br>
To turn on/off the display via code, we need an switch.<br>
In our case, since we use AC not DC, we need an AC switch.<br>
The ESP32 microcontroller does not have a suitable AC switch built-in. Thus, we have to build our own. <br>
Our switch will consist of a <b>triac</b> and an <b>optocoupler</b>.<br><br>

A <b>triac</b> is similar to a transistor but also blocks alternating current (AC) while a transistor can only block direct current (DC). By switching the triac on/off, we can thus block the AC current coming from the power supply (i.e. our battery), which allows us to turn the display on/off under computer control. The triac's pins and how you add it to a circuit is similar to a transistor. It has two connectors for + and GND and a Gate that can trigger it to let current pass through or block it. The symbol and a picture of the triac that we will use in this lab are below:<br><br>
    
<img src="images/lab6/Triac.png" width="100px"><img src="images/lab6/triac_image.png" width="200px"><br><br>
    
<b>Isolating the Microcontroller Control Circuit from the Power Circuit</b><br>

    The ESP32 is rated only up to 12V so a higher voltage like the 50V AC we use could potentially damage the microcontroller's components. Therefore, we have to isolate the ESP32 from the 50V AC power supply. For this purpose, we will use an <b>optocoupler</b>, which uses optical signaling rather than electrical signaling, which allows it to isolate each part of the circuit while still enabling communication between the two. An optocoupler houses an LED and a photo-triac. When the LED turns on, it activates the photo-triac and energy then flows. Both components are optically connected but not electronically connected through a wire. The trigger mechanism works purely through light. This safety measurement ensures that no voltage of the 50V power supply can jump over to the microcontroller. You can see how the symbol and the component looks like:<br><br>
    
<img src="images/lab6/opto_symbol.PNG" width="200px"><img src="images/lab6/opto_img.PNG" width="200px"><br><br>

We will setup the components to work together in the following way:<br>
(1) the ESP32 controls the optocoupler and thereby protects itself from any high voltage.<br> 
(2) The optocoupler then controls the triac to open and close the AC switch to let power through or cut if off. <br><br>

We have to add a few resistors to the circuit. First, these resistors limit the current that reaches the optocoupler's LED and prevents it from blowing up.<br> In addition, it limits the current that reaches the triac to prevent it from being damaged. The final circuit looks like this:<br>

 <!-- It's also a (sometimes) triac but instead of being triggered with a physical wire (Gate) it contains a LED and a photo-triac and both components are galvanically isolated.  -->

Bringing it all together, our AC switch circuit should look like this:<br><br>
    
<img src="images/lab6/optotriac_circuit.PNG" width="700px"><br><br>   

Get yourself a breadboard, wires and the components and build it.<br>
<span style="color:red">Note that the optocoupler has to be plugged in in a specific orientation.</span> Look at the <a href="https://www.mouser.com/datasheet/2/308/MOC3163M-D-1811983.pdf" target="_blank">datasheet of the optocoupler here</a> to find out where the pins are. <br> The little dot on its top indicates the top left corner of the component. <br><br>

<h3 id="XX">(6) Write Program to turn the Display On/Off</h3>

Now that we have wired up our control circuit, we still have to write the code for it.<br>
As an example, we will write a script that lets the display blink. <br>
This is very simple with the circuit you already built.<br>
Check again, to which pin you connected the <b>optocoupler</b> and use this pin to turn it on and off.<br><br>

<h3 id="XX">(7) Write Program to Dim Display</h3>

Finally, we want to not just turn the display on/off but also set the displays brightness (e.g. dimming it down).<br>
In 6.08 (pre-requisit for this class), you already learned about pulse-width-modulation (PWM) to dim light sources like an LED.<br><br>

<b>Duty Cycle:</b> When you create a PWM signal it means that you turn on and off a signal for a certain duty cycle.<br> 
The longer the signal is turned on in one duty cycle the brighter the light source will be (see Figure below).<br>
Similarly, the longer the signal is turned off in one duty cycle the darker the light source will be.<br>
Thus, a duty cycle of 25% results in a darker display than a duty cycle of 75%.<br><br>

<img src="images/lab6/pwm-explanation2.png" width="500px"><br><br>
        
<b>Frequency:</b> So how is the duty cycle related to the frequency? The duty cycle only tells you the percentage the signal is on/off within a cycle (e.g., 25%). It does not say how long a cycle is. For this, you need to define the frequency. A higher frequency results in a shorter overall cycle (not affecting the percentage the signal is on/off) than a lower frequency as you can see below.<br><br>

<img src="images/lab6/ac-frequency.png" width="500px"><br><br>

<b>What frequency should the PWM signal have?</b><br>
If the frequency is very high and thus the duty cycle is compressed into a short time window, the turning on and off of the signal (i.e. the display) happens very fast.<br>
If it is fast enough, humans do not notice that the display is turned on and off, which is great because we can use the on/off mechanism to create different brightness level without the user noticing that we are effectively just turning the display on/off at a very fast rate. <br>
The frequency should thus be high enough that the duty cycles are not visible to the human eye.<br><br>

But can the frequency be arbitrary high?<br>
It turns out, the answer is no.<br><br>
<!-- ecause of zero-crossing circuit inside the optocoupler
 -->
<b>Why can the frequency not be arbitrarily high?</b><br>

Before we can answer this question, it is important to realize that in our circuit, we are dealing with two different signals.<br>
One signal is coming in the form of the <b>AC signal from our inverter</b>. <br>
The other signal is coming in the form of the <b>PWM signal from our ESP</b>.<br><br>

The frequency of the inverter's AC signal is given at 800Hz for our 1.2V battery.<br>
<!--  (if we connected the inverter to 3.3V on the ESP it would be 1.6KHz).<br>
 -->
 The frequency of the PWM signal is something we can choose as mentioned above.<br><br>

<img src="images/lab6/inverter-pwm-signal.png" width="400px"><br><br>

So why can the frequency of the PWM signal not be arbitrarily high?<br>
The reason for this is something called <b>'zero crossing'.</b><br><br>

<b>What is a zero-crossing?</b><br>

A zero-crossing is when the AC signal crosses the x-axis as shown in the image below.<br><br>

<img src="images/lab6/ac-signal-viz-zero-crossing.jpg" width="400px"><br><br>

When you check out  <a href="https://www.mouser.com/datasheet/2/308/MOC3163M-D-1811983.pdf" target="_blank">the optocoupler's datasheet,</a> you will see that it contains a "zero-crossing circuit". <br><br>

<img src="images/lab6/zero-crossing-circuit-optocoupler.png" width="400px"><br><br>

What this means is that the optocoupler will only switch the display on/off when the <b>AC signal of the inverter</b> crosses zero and the PWM signal tells the optocoupler to change the display state. <br><br>

So what happens if your PWM frequency is higher than your inverter frequency?<br>
The image below shows this: Although the PWM frequency demands that the display be switched off/on, the optocoupler will do nothing since there is no zero-crossing in that time frame.<br>
Thus, if our PWM signal is faster than the inverter's AC frequency, the optocoupler switch cannot react fast enough.<br>
As a result, the optocoupler switch will react at some random point in time later, which disrupts the chosen duty cycle and makes it longer or shorter. Since the duty cycle is not consistent anymore, you will see the display flicker since it goes into random brightness states.<br><br>

<img src="images/lab6/inverter-pwm.png" width="500px"><br><br>

Now let's look at the same scenario when the PWM frequency is lower than the inverter frequency.<br>
This will work well as you can see in the image below.<br> 
When the PWM frequency demands the display to be switched off/on, there are several zero-crossings where the optocoupler can take action.<br><br>

<img src="images/lab6/inverter-pwm-slow.png" width="500px"><br><br>

Thus, we have to select a PWM frequency that is significantly lower than the AC power supply frequency.<br>
To be significantly below the inverter's AC frequency, we should set the PWM signal to around 100Hz to get a good result in our dimming. <br><br>


    
<b>Setting the PWM frequency:</b><br>
You can set the PWM frequency using the ledcSetup command. <br><br>
    
<pre>ledcSetup(ledChannel, freq, duty_resolution);</pre>

<i>Channel Number:</i> The LEDC peripheral has 16 channels which can generate independent waveforms (note that these are NOT pin numbers on the ESP, but internal channels inside the ESP). The channel numbers range from 0-15. For our purposes, you can pick any channel you like.<br><br>

<i>Frequency:</i> As mentioned previously, the frequency should be 100.<br><br>

<i>Duty resolution:</i> The duty resolution is expressed in bits and determines how many different duty cycles we can choose from, i.e. how many different brightness options we will have when dimming the display. For instance, 3 bits gives us 8 different cycles to choose from (12.5%, 25%, 37.5%,... 100%).<br><br>

<b>Specifying the Output Pin of the PWM Signal</b><br>
Now that you specified the signal, you need to specify on which pin number the signal should appear. Remember that this is the pin that goes from the ESP to the display control circuit. The PWM channel number is the same as above. <br><br>

<pre>ledcAttachPin(GPIO_PIN, channel_number) </pre> <br>

<b>Generating the PWM Signal on the Output Pin</b><br>
Finally, you need to generate the actual PWM signal, which you had previously defined with the ledcSetup() function.<br> <br>

<pre>ledcWrite(channel_number, duty_cycle): </pre> <br>

The PWM channel number is the same as above.<br> 
The duty <b>cycle</b> is different from the duty <b>resolution</b> and explained below:<br><br>

<i>Duty Cycle:</i> In the duty cycle parameter, you tell the ledcWrite() function, which of the duty cycles from your duty resolution should be used. Since we chose 3 bits, which gives us 8 values ranging from 12.5%, 25%, 37.5% .... 100%, then our duty cycle parameter is the index of the duty cycle you want to use. For instance, using 2 for the duty cycle parameter would give you 37.5% for the duty cycle. 

Use PWM to let the display increase and decrease in brightness. The increase from 0% to 100% duty cycle should take 2 seconds and then dim it down again in another 2 seconds. Finally, let the display repeat this dimming infinitely.<br>




<h2 class="headline">Deliverables Lab 3 (due Friday, Sept. 25, 2020, 11.59pm)</h2>

At the end of Lab 3, upload to your student google drive:
<ul>
  <li>the Arduino code (.ino) for dimming your display</li>
  <li>2-3 photos (.jpg or .png) from different angles of your circuit</li>
  <li>a short video (.mov or .mp4, max. 1 minute) showing how you display dims and performs a full cycle from bright to dark and dark to bright again</li>
</ul><br>

<hr>


        <br />
        <br />
        <br />
      </section>

     <aside class="col-md-4 pull-left">
         <br /> <br /> <br /> <br /><br>

                 <h4 class="medium.headline" style="padding-bottom:10px;"><a href="lab-series-interactive-mug.html"><b>Lab Series: Interactive Mug</b></a><br></h4>

<ul>
    <li><a href="lab5-fabricating-el-display.html">Lab 5: Fabricating the Electroluminescent Display</a></li>
    <li><a href="lab6-controlling-el-displays.html">Lab 6: Controlling the Electroluminescent Display</a></li>
    <li><a href="lab3-sending-touch-data-to-processing.html">Lab 7: Inkjet Printed Temperature Sensor</a></li>
</ul><br>


<iframe width="173" height="210" src="https://www.youtube.com/embed/E8sfqrH_1Ks" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><br><br>

In this lab series, you will create an interactive mug. The mug consists of a sprayed electroluminescent display and an inkjet printed temperature sensor. When the user pours in tea or coffee, the mug can sense the temperature of the liquid and when its too hot, blink the display as a warning.<br><br>



</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>

      </aside>

    </div>
  </div>
  </div>
</section>

<div class="container">
	<div class="row">
		<div class="col-md-12 footer" style="text-align: center;">
			<span class="copyright">
			Since 2017 &copy; MIT CSAIL (HCI Engineering group) [redesign by
			<a href="http://punpongsanon.info/" target="_blank" style="text-decoration:none; border-bottom:0px">
			moji
			</a>].
			All Rights Reserved.

			<a href="http://mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/mit.svg" alt="MIT" class="footer-logo" />
			</a>
			<a href="http://csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/csail.svg" alt="CSAIL" class="footer-logo"/>
			</a>
			<a href="http://hci.csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/hci.svg" alt="HCI" class="footer-logo"/>
			</a>
			</span>
		</div>
	</div>
</div>

<!-- Bootstrap -->
<script type="text/javascript" src="../../js/bootstrap.min.js"></script>
<!-- header -->
<script type="text/javascript" src="../../js/headerstrap-for-subpage.js"></script>

</body>
</html>
