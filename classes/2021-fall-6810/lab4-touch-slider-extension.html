<!DOCTYPE html>
<html>
<head>
	<title>HCI Engineering Group</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

	<!-- CSAIL ICON -->
	<link rel="CSAIL" href="../../../images/icon/csail.ico" type="image/x-icon" />

	<!-- Bootstrap -->
	<link href="../../css/bootstrap.css" rel="stylesheet">
	<link href="../../css/custom-style.css" rel="stylesheet">

	<!-- jQuery -->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Abel" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Barlow" rel="stylesheet">

	<!-- Google Analytic -->
	<script type="text/javascript" src="../../js/analytics.js"></script>

	<style>
	.etech-sch-col1 {width:60px; border: 1px solid black;padding:10px;}
	.etech-sch-col2 {width:120px; border: 1px solid black;padding:10px;}
	.etech-sch-col3 {width:450px; border: 1px solid black;padding:10px;}
	.etech-sch-col4 {width:70px; border: 1px solid black;padding:10px;}
  .etech-sch-col5 {width:70px; border: 1px solid black;padding:10px;}
  /*.etech-sch-col6 {width:170px; border: 1px solid black;padding:10px;}*/
  ul {
    padding:0px;padding-left:10px;margin:0px;
  }
	</style>
</head>

<body>
<header class="main_header">
	<!-- to be filled by javascript, see header.html -->
</header>

<section class="main_container">
	<div class="container">
    <div class="row nothing">

      <section class="col-md-8 pull-right main-content">
</br></br></br></br>
        <h4 class="medium.headline"><a href="6810-engineering-interactive-technologies.html">6.810 Engineering Interactive Technologies (fall 2021)</a><br></h>
        <h2 class="headline">Lab 4: Sensing Input from a Touch Slider</h2>
      
In this lab, you will extend your circuit, signal processing, and the Processing visualization to include the touch slider for control the volume of the music that is being played.<br><br>

<img src="images/lab2/slider_teaser.png" width="350px" /><img src="images/lab4/lab2-volume-middle_UI_new.png" width="400px"><br>

<span style="color:red">Replace finger image with a GIF</span>
    
<h3>Steps:</h3>
<ol>
  <li><a href="#1">Build the Slider Circuit</a></li>
  <li><a href="#2">Extend Microcontroller Code to Read Slider Segments</a></li>
  <li><a href="#3">Measure Min and Max Signal Thresholds</a></li>
  <li><a href="#4">Computing the Relative Position of a Finger</a></li>
  <li><a href="#5">Computing the Overall Slider Value</a></li>
  <li><a href="#6">Write Slider Value to Serial Port</a></li>
  <li><a href="#7">Add Slider onto the Card</a></li>
  <li><a href="#8">Connect your Physical Music Card to Processing</a></li>
</ol>

    
<h3>Deliverables</h3>

At the end of the lab, upload to your student google drive:
<ol>
 <li>the updated Arduino code you wrote for Serial Communication of the slider touch values (.ino file format)</li>
  <li>the Processing code (.pde) you wrote for Serial communication that displays the slider bar</li>
  <li>the Processing code (.pde) of the music card application with the slider</li>
  <li>a short video (.mov or .mp4, max. 1 minute) showing how you use the slider to adjust the volume</li>
</ol><br>

<hr>

<h3 id="1">(1) Build the Slider Circuit</h3>

In the last lab, you built and implemented the hardware and software for the touch sensors on your music card. In this lab, you will implement the slider on the bottom of your music card. The first step is to connect each slider element as a regular touch sensor to your ESP32. Converting the received touch signals to a continuous slider signal will be done in software. Let's first build the touch circuits for the slider elements:<br><br>
    
<b>One Sender Pin, Different Receiver Pins:</b> Start by wiring up each slider segment exactly the way how you wired up the touch buttons. Remember they can all use the same sender pin but need a different receiver pin. Refer to <a href="lab2-sensing-touch-button.html" target="_blank">Lab 2</a> if you don't remember how this works.<br><br>

    <b>Use 'TOUCH' Pins:</b> Remember to use the pins with "TOUCHX" labels for better signal quality but do not use the one pin labeled as pin0 (TOUCH1) as receiver (you can still use it as sender). Below is the ESP pin out again for your reference.<span style="color:red">Faraz: Check if this is still correct with the new ESP32</span><br><br>
    
<img src="images/lab2/esp32.png" width="750px" /><br><br>

<h3 id="2">(2) Extend Microcontroller Code to Read Slider Segments</h3>

<b>Read Slider Segment Signal Values:</b> Once finished with the wiring, extend your Arduino code to also read each slider segment's raw touch signal.<br><br>

<b>Plot each Signal Value to the Serial Plotter:</b> Next, serial print the received raw touch signals for each slider segment and look at them in the Serial plotter. To visualize only the slider touch signals in the serial plotter, you have to format the serial output in the same way as you did in lab 2. This is: "slider1","slider2","slider3","slider4","slider5""newline" <br><br>

Below you can see the serial plotter output for individually touching each of the five slider segments.<br><br>
<img src="images/lab4/lab2-slider-segments-raw-value.png" width="400px" /><br><br>


<h3 id="3">(3) Measure Min and Max Signal Thresholds</h3>

For the touch buttons, we were merely interested if the button is touched or not, thus we converted the touch signal into a <i>binary value 0 or 1</i>. For the slider, we want to compute at which position the finger is between two slider elements. This will allow us to more smoothly adjust the music volume rather than jumping from one discrete volume level to the next. We can see by 'how much' a slider segment is touched by looking at the raw touch signals coming from the microcontroller. When looking at the Serial Plotter, you will notice that the raw value has a strong correlation with how much space of the slider segment is touched, i.e. the larger the touch area of you finger on the slider segment the higher the value is. <br><br>
    
<span style="color:red">Faraz: Replace image below with a demo video. Finger moves on one slider segemnt from the left to the right. ScreenCapture the serial plotter that shows only one signal of the active slider segment. It should be visible how the value slowlier rises from 0 to max and then drops from max to 0 again</span><br><br>

<img src="images/lab4/lab2-slider-segments.png" width="330px" /><img src="images/lab4/lab2-minimum-touch-threshold.png" width="420px" /><br><br>

Let's start by computing the continues value for one slider segment.<br><br>

<b>Determine Min Value when Slider Segment is Not Touched:</b> First, we want to determine what is noise (i.e. small signal readings when nothing is actually touched) and want to discard those values. To find the minimum value when you should consider a touch signal, we recommend looking at the Serial plotter and noting down the values of the slider segments when none of them are touched. This will be your minimum threshold to check if a button is touched.<br><br>

<b>Determine Max Value when Slider Segment is Fully Touched:</b> Next, determine the max value when the slider segment is fully touched with you finger, i.e. your finger overlaps with the entire slider segment.<br><br>
    
<h3 id="4">(4) Computing the Relative Position of a Finger</h3>
    
<b>Add min and max threshold to your code:</b> Create two integer arrays Min and Max that contain the min and max values that you measured for each slider element<br><br>

<b>Compute relative position of a finger:</b> Now, let's create a function that computes the relative position between two slider segments. The function should read in two sensor signals and the two sensorIDs of the touched segments and it sould return a float between 0..1 that represents the relative position of the finger between two segements (0:left segment, 1:right segment).<br>
Compute the fraction of the received sensor signal compared to its corresponding max value: frac1 = sensor1/MAXsensor1 and frac2 = sensor2/MAXsensor2. These are the estimates of the relative finger position from each slider segment. Finally, compute an average between both values. Be aware that moving the finger to the right means that slider1 will drop in value and slider2 will increase in value. Thus, compute the relative averaged finger position as res = ((1-frac1)+frac2)/2. This is the return value of your function.

<h3 id="5">(5) Computing the Overall Slider Value</h3>
    
The task here is to extend the code to compute the finger position on all 5 slider segments.<br><br>
    
<b>Identify if two slider segments are touched</b><br>
Implement an if statement that constantly checks if two slider segments exceed their min threshold at the same time. In that case, we can assume that a finger is touching 2 slider segments and you can pass over the received signals and slider segments IDs to the function you created in the previous step.<br><br>
    
<b>Compute the relative position of a finger</b><br>
You should receive from your function of the previous step a value between 0 and 1. To convert this value to a position on the whole slider segment, you have to to take into account the position of the touched slider segments. For example, if slider segment 3 and 4 are touched, the values should range between 0.5 and 0.75. Thus, we first have to scale down the returned value of the function to 0.25 by multiplying 0.25*res. The range of the return value will now be between 0 and 0.25. Next, we have to add the relative position. If slider 3 and 4 are active, you have to add 0.5 to the function value. Altogether, the relative position can be computered as RelPos + 0.25*res. RelPos should be 0 for the first slider segment, 0.25 for the second and so on.<br><br>
    
<img src="images/lab2/slider_vis_continuous.png" width="400px"><br><br>
    
<b>Identify if only on slider segment is touched</b><br>
In case only one slider segment exceeds its MinThreshold, you can simply compute the the discrete position on the whole slider. This would be the Relpos value of the previous paragraph. For example, 0 for slider segment 1 or 0.25 for slider segment 2, and so on.<br><br>
    
<img src="images/lab2/slider_vis_discrete.png" width="400px">

<h3 id="6">(6) Write Slider Value to Serial Port</h3>

Write the slider value to the Serial port so that you can read it out later in Processing. For the calculated slider value, format the output like we did before for the touch button so that:<br>

<code>(sensor ID),(slider_value);</code><br><br>
    
(sensor ID) is 3, and represents the ID of the slider (we already used up sensor IDs 0, 1, 2 for the touch buttons).<br>
(slider_value) is ranging from 0.0 to 1.0 to indicate the overall slider position (music volume).<br><br>

A sample output hould look like:<br>
<pre><code>3,0.78;
3,0.86;
3,0.97; 
</code></pre> 
The output should print continuously as long as the slider is touched. <br>

<br>

<h3 id="7">(7) Add Slider onto the Card</h3>

Let's add the slider to the music card to control the music volume.<br> Open the music card code again.<br><br>

We already implemented a class 'Slider' for you.<br>
You can make a new slider with:<br><br>

<pre><span style="red">mySliders.add(new Slider(start_x, start_y, end_x, end_y));</span></pre>

Please add one slider to the code, just like how you added the button. <br>
Add code to the draw() function to display the slider when it is not in "hide" mode.<br><br>

Your result should look like this.<br>
You should be able to control the slider by dragging your mouse (with left mouse button pressed): <br><br>

Dragging the mouse on the slider from left to right:<br>
<img src="images/lab4/lab2-volume-low_UI_new.png" width="350px">
<img src="images/lab4/lab2-volume-middle_UI_new.png" width="350px">
<!-- <img src="images/lab2-volume-high_UI.png" width="200px"> -->
<br><br>

<h4>Create Slider Events for the Music Volume Control</h4><br>

To create events on mouse drag, we need to implement several mouseDragged() events.<br>
We already did some parts of it for you in the code further down in the class.<br>
Please go ahead and extend the code so that it changes the music volume based on the slider level. <br>
You might find the following functions from the "Audio" and "Slider" classes useful: <br>
<br><pre>
music.changeVolume(double intensity);
Slider.getIntensity();</pre><br><br>

Once you finished your code, test if the music volume actually changes by first playing a song with the virtual touch button and then dragging the slider to adjust the music volume. If everything works, move on.<br><br>
    
<h4>Hide the Slider</h4><br>

Similar to the previously added buttons, you can hide the Slider by pressing the 'h' key on your keyboard while your program runs.<br>
If you want to see them again, press 's' (for show).<br><br>

<h3 id="8">(8) Connect your Physical Music Card to Processing</h3>

Now that we can control the slider digitally, we also want to adjust the volume of the music from the physical card.<br><br>
Read in the Serial messages from your ESP32 that include the values for the finger position on the slider. Use these values to change the valume of the music and integrate it into the music card Processing Script.<br>

<img src="images/lab4/lab2-volume-low_new.png" width="350px">
<img src="images/lab4/lab2-volume-middle_new.png" width="350px">
<!-- <img src="images/lab2-volume-high_UI.png" width="200px"> -->
<br><br>

Now test if everything works by using your physical printed card to play/pause songs and the physical slider to adjust the music volume. If it works, congrats, you are done :)!<br><br>

<h3>Deliverables</h3>

At the end of the lab, upload to your student google drive:
<ol>
 <li>the updated Arduino code you wrote for Serial Communication of the slider touch values (.ino file format)</li>
  <li>the Processing code (.pde) you wrote for Serial communication that displays the slider bar</li>
  <li>the Processing code (.pde) of the music card application with the slider</li>
  <li>a short video (.mov or .mp4, max. 1 minute) showing how you use the slider to adjust the volume</li>
</ol><br>
    


        <br />
        <br />
        <br />
      </section>

      
     <aside class="col-md-4 pull-left">
         <br /> <br /> <br /> <br /><br>

                 <h4 class="medium.headline" style="padding-bottom:10px;"><a href="lab-series-inkjet-printed-card.html"><b>Lab Series: Inkjet Printed Music Card</b></a><br></h4>

<ul>
    <li><a href="lab1-circuit-design-for-inkjet-printing.html">Lab 1: Circuit Drawings for Conductive Inkjet Printing</a></li>
    <li><a href="lab2-sensing-touch-button.html">Lab 2: Sensing Touch from Inkjet Printed Circuit</a></li>
   	<li><a href="lab3-sending-touch-data-to-processing.html">Lab 3: Sending Touch Data to Processing</a></li>
    <li><a href="lab4-touch-slider-extension.html">Lab 4: Sensing Input from a Touch Slider</a></li>
</ul><br>


<iframe width="280" height="158" src="https://www.youtube.com/embed/R7qxT6_8TE4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><br><br>

In this lab series, you will create an interactive music card. Underneath the visual design, the music card has an inkjet printed circuit with touch buttons and a slider that allow the user to play songs and control the volume. The card is connected to a microcontroller for analyzing user input and then sends the signals to a program called Processing for visualizing user input on screen.<br><br>


</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>

      </aside>

    </div>
  </div>
  </div>
</section>

<div class="container">
	<div class="row">
		<div class="col-md-12 footer" style="text-align: center;">
			<span class="copyright">
			Since 2017 &copy; MIT CSAIL (HCI Engineering group) [redesign by
			<a href="http://punpongsanon.info/" target="_blank" style="text-decoration:none; border-bottom:0px">
			moji
			</a>].
			All Rights Reserved.

			<a href="http://mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/mit.svg" alt="MIT" class="footer-logo" />
			</a>
			<a href="http://csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/csail.svg" alt="CSAIL" class="footer-logo"/>
			</a>
			<a href="http://hci.csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/hci.svg" alt="HCI" class="footer-logo"/>
			</a>
			</span>
		</div>
	</div>
</div>

<!-- Bootstrap -->
<script type="text/javascript" src="../../js/bootstrap.min.js"></script>
<!-- header -->
<script type="text/javascript" src="../../js/headerstrap-for-subpage.js"></script>

</body>
</html>
