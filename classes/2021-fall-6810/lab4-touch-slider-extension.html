<!DOCTYPE html>
<html>
<head>
	<title>HCI Engineering Group</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

	<!-- CSAIL ICON -->
	<link rel="CSAIL" href="../../../images/icon/csail.ico" type="image/x-icon" />

	<!-- Bootstrap -->
	<link href="../../css/bootstrap.css" rel="stylesheet">
	<link href="../../css/custom-style.css" rel="stylesheet">

	<!-- jQuery -->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Abel" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Barlow" rel="stylesheet">

	<!-- Google Analytic -->
	<script type="text/javascript" src="../../js/analytics.js"></script>

	<style>
	.etech-sch-col1 {width:60px; border: 1px solid black;padding:10px;}
	.etech-sch-col2 {width:120px; border: 1px solid black;padding:10px;}
	.etech-sch-col3 {width:450px; border: 1px solid black;padding:10px;}
	.etech-sch-col4 {width:70px; border: 1px solid black;padding:10px;}
  .etech-sch-col5 {width:70px; border: 1px solid black;padding:10px;}
  /*.etech-sch-col6 {width:170px; border: 1px solid black;padding:10px;}*/
  ul {
    padding:0px;padding-left:10px;margin:0px;
  }
	</style>
</head>

<body>
<header class="main_header">
	<!-- to be filled by javascript, see header.html -->
</header>

<section class="main_container">
	<div class="container">
    <div class="row nothing">

      <section class="col-md-8 pull-right main-content">
</br></br></br></br>
        <h4 class="medium.headline"><a href="6810-engineering-interactive-technologies.html">6.810 Engineering Interactive Technologies (fall 2021)</a><br></h>
        <h2 class="headline">Lab 4: Sensing Input from a Touch Slider</h2>
      
In this lab, you will extend your circuit, signal processing, and the Processing visualization to include the touch slider for control the volume of the music that is being played.<br><br>

<img src="images/lab4/lab2-slider-segments-overlap-segments.png" width="350px" /><img src="images/lab4/lab2-volume-middle_UI_new.png" width="400px"><br>


<h3>Steps:</h3>
<ol>
  <li><a href="#INSTALLPROCESSING">Build the Slider Circuit</a></li>
  <li><a href="#NEWPROCESSINGPROGRAM"></a></li>
  <li><a href="#OPENSERIAL"></a></li>
  <li><a href="#SERIALREAD"></a></li>
  <li><a href="#EXTRACTTOUCHSTRING"></a></li>
  <li><a href="#DRAWDIGITALBUTTON"></a></li>
</ol>

<h3>Deliverables</h3>

At the end of the lab, upload to your student google drive:
<ol>
 <li>the updated Arduino code you wrote for Serial Communication of the slider touch values (.ino file format)</li>
  <li>the Processing code (.pde) you wrote for Serial communication that displays the slider bar</li>
  <li>the Processing code (.pde) of the music card application with the slider</li>
  <li>a short video (.mov or .mp4, max. 1 minute) showing how you use the slider to adjust the volume</li>
</ol><br>

<hr>

<h3 id="INSTALLPROCESSING">(1) Build the Slider Circuit</h3>

<b>One Sender Pin, Different Receiver Pins:</b> Start by wiring up each slider segment exactly the way how you wired up the touch buttons. Remember they can all use the same sender pin but need a different receiver pin. Refer to Lab 2 if you don't remember how this works.<br><br>

<b>Use 'TOUCH' Pins:</b> Remember, use the pins with "TOUCHX" labels for better signal quality but do not use the one pin labeled as pin0 (TOUCH1) as receiver (you can still use it as sender). Below is the ESP pin out again for your reference.<br><br>

<img src="images/lab4/esp32-pinout.jpg" width="400px" /><br><br>

<h3 id="INSTALLPROCESSING">(2) Extend Microcontroller Code to Read Slider Segments</h3>

<b>Read Slider Segment Signal Values:</b> Once finished with the wiring, extend your Arduino code to also read each slider segment's raw touch signal.<br><br>

<b>Plot each Signal Value to the Serial Plotter:</b> Next, serial print the received raw touch signals for each slider segment and look at them in the Serial plotter. <span style="color:red">do we have to format the serial print statement in a specific way to get the serial plotter to work?</span><br><br>

Below you can see the serial plotter output for individually touching each of the five slider segments.<br><br>
<img src="images/lab4/lab2-slider-segments-raw-value.png" width="400px" /><br><br>


<h3 id="INSTALLPROCESSING">(3) Determine Finger Overlap with Slider Segments</h3>

For the touch buttons, we were merely interested if the button is touched or not, thus we converted the touch signal into a <i>binary value 0 or 1</i>. For the slider, each slider segment should return a <i>continuous value from 0.0 to 1.0</i> depending on the area the finger overlaps with the slider segment. This will allow us to more smoothly adjust the music volume rather than jumping from one discrete volume level to the next. We can see by 'how much' a slider segment is touched by looking at the raw touch signals coming from the microcontroller. When looking at the Serial Plotter, you will notice that the raw value has a strong correlation with how much space of the slider segment is touched, i.e. the larger the area the higher the value is. <br><br>

<img src="images/lab4/lab2-slider-segments.png" width="330px" /><img src="images/lab4/lab2-minimum-touch-threshold.png" width="420px" /><br><br>

Let's start by computing the continues value for one slider segment.<br><br>

<b>Determine Min Value when Slider Segment is Touched only a little:</b> First, we want to determine what is noise (i.e. small signal readings when nothing is actually touched) and want to discard those values. To find the minimum value when you should consider a touch signal, we recommend looking at the Serial plotter and investigating the values when no touch occurs and when the finger barely touches a slider segment. Choose a value close to the 'barely touch' value.<br><br>

<b>Determine Max Value when Slider Segment is Fully Touched:</b> Next, determine the max value when the slider segment is fully touched with you finger, i.e. your finger overlaps with the entire slider segment.<br><br>

<b>Compare Current Signal Value against Max Value to Determine Percentage of Overlap:</b> Next, check how the current touch signal value related to the maximum value to compute the percentage of overlap, i.e. the value beteen 0.0 and 1.0. 

<b>Extend Code to all Slider Segments:</b> Next, extend the code to compute the individual percentage for each slider segment. You can assume that for each of your slider segments you can use the same thresholds since all of your slider segments have the same size, and while each has a slightly different wire length this should be negligible. If your slider segments have vastly different values (e.g., because of some damage to the silver), you need to create separate thresholds for each segment. You can check this by plotting each silder segments' raw values. <br><br>

<h3 id="INSTALLPROCESSING">(4) Computing the Overall Slider Value</h3>

Once you have the continous signal (0.0 - 1.0) for each slider segment, you can compute the overall slider value. 




The task here is to convert the five seperate slider segment values (all from 0.00-1.00) and combine them into one value that represents the overall slider position ranging from 0.00-1.00 (0-100 percent).<br><br>

<img src="images/lab4/lab2-slider-segments-global-value.png" width="400px" /><br><br>

For this, we will use some simple linear interpolation.<br>
We can also assume that at any given time, there will be at most 2 adjunct slider segments being touched (i.e. the user will only use one finger on the slider at any given time and the one finger will touch at max two adjacent slider segments since we made each segment roughly the size of the finger). <br><br>

<b>Assigning Slider Portions to Percentage Values</b><br>

Since we have 5 slider segments in our example, one could say that each slider segment is representing 20% (0.2) of the overall music volume.<br>
Thus, when we know slider segment 2 is touched, it must be a music volume between 20-40%.<br>
To figure out the exact value between 20-40%, we can then look at the slider segments value.<br><br>

However, because we have overlapping slider segments, looking at each segment individually actually doesn't help us very much to compute one global continous value.<br>
Instead, we need to consider two adjacent segments since they will almost always be touched together.<br>
To be able to consider adjacent segments, we therefore split the slider into 4 segments that overlap with each other as shown below. Each overlapping segment thus represents 25% of the overall volume.<br>
If we only touch the first or only touch the last segment, we assume we are at 0% or 100%.<br><br>

<img src="images/lab4/lab2-slider-segments-overlap-segments.png" width="400px" /><br><br>


<!-- <b>Global Slider Value When Only One Slider Segment is Touched</b><br>
Let's look at the most easy example, i.e. only one slider segment is touched.<br>

Let's assume, we read a value of 0.2 from the slider segment 3, we can then conclude that we are at 1/5th of the overall range from 40-60%, i.e. 1/5th of 20 = 4, 40% + 4% = 44%). <br><br>

Thus, when only one slider segment is touched, we can calculate the overall slider value based on:<br> 
1) the touched slider segment's order (0 to 4 representing 0-20%, 20-40%, 40%-60%, etc.) <br>
2) the touched slider segment's value (0.00-1.00 representing intermediate values) <br> <br>
 -->
<!-- We can you the following formula:
 -->
<!-- <b> slider_value = slider_segment_value * 0.2 + slider_segment_order * 0.2 </b>, e.g. the second slider segemnt touched with the value 0.80, the overall slider value would be 0.80 * 0.2 + 1 * 0.2 = 0.36; the third slider segemnt touched with the value 0.80, the overall slider value would be 0.80 * 0.2 + 2 * 0.2 = 0.56. <br><br> -->

<b>Global Slider Value When Two Slider Segments are Touched</b><br>

Consider what happens as we slide from left to right from slider segment 2 towards slider segment 3.<br>
First, the slider value of segment 2 will get higher as more and more area of our finger overlaps with the slider segment.<br>
Then, as we move towards the slider segment 3, the value of slider segment 2 decreases again as more and more of our finger leaves the slider segment 2 and instead overlaps with the slider segment 3.<br>
Thus, once we know that the finger touches the slider segment 3, a lower sensor value of segment 2 actually means a higher slider value and not a lower one!<br>
To compensate for this, if we detect that segment 3 is touched, we subtract the segment 2 slider value from 1.0.<br>
e.g. segment2 = 0.25 && segment3 is touched then segment2 = 1.0-0.25 (results in 0.75).<br>
For slider segment 3, we can simply read the regular value and use it.<br><br>

Next, we still have to map the two slider values to an overall slider value.<br>
For this, we first compute the mean of both values ((0.75+0.78)/2 = 0.765) and then map the resulting number onto the value range of the slider volume area (i.e in our example the area we are looking at is from 25%-50% since this covers both slider segment 2 and 3). Since the slider volume slider area is 25-50% and we are at 76.5% between these values, the final slider value is 25%+((50-25)*0.765) = 44.125% as the final slider value. <br><br>

<img src="images/lab4/lab2-slider-segments-final-value.png" width="400px"><br><br>

<h3 id="INSTALLPROCESSING">(5) Write Slider Value to Serial Port</h3>

Write the overall slider value to the Serial port so that you can read it later from Processing. For the calculated slider value, format the output like we did before for the touch button so that:<br>

<code>(sensor ID),(slider_value);</code><br><br>
    
(sensor ID) is 3, and represents the ID of the slider (we already used up sensor IDs 0, 1, 2 for the touch buttons).<br>
(slider_value) is ranging from 0.00 to 1.00 to indicate the overall slider position (music volume).<br><br>

A sample output hould look like:<br>
<pre><code>3,0.78;
3,0.86;
3,0.97;
</code></pre> 
The output should print continuously as long as the slider is touched. <br>

<br>

<h4>Create Slider Visualization</h4><br>

Now that the slider values are printing to the Serial port, we can read them from Processing.<br>
Open your Processing program that had the three touch bars and add a horizontal bar for the slider.<br> 
The bar represents the entire slider. Thus, if the finger is on the left side of slider, the bar should be short and if the finger slides more to the right side of the slider, the bar should be long.<br><br>

<img src="images/lab4/lab2-slider-visulization-low.png" width="300px">
<img src="images/lab4/lab2-slider-visulization-high.png" width="300px"><br><br>

<h4>Add Slider onto the Card</h4><br>

Now that you know the slider values can be visualized in Processing, let's add it to the music card to control the music volume.<br> Open the music card code again.<br><br>

We already implemented a class 'Slider' for you.<br>
You can make a new slider with:<br><br>

<pre><span style="red">mySliders.add(new Slider(start_x, start_y, end_x, end_y));</span></pre>

Please add one slider to the code, just like how you added the button. <br>
Add code to the draw() function to display the slider when it is not in "hide" mode.<br><br>

Your result should look like this.<br>
You should be able to control the slider by dragging your mouse (with left mouse button pressed): <br><br>

Dragging the mouse on the slider from left to right:<br>
<img src="images/lab4/lab2-volume-low_UI_new.png" width="350px">
<img src="images/lab4/lab2-volume-middle_UI_new.png" width="350px">
<!-- <img src="images/lab2-volume-high_UI.png" width="200px"> -->
<br><br>

<h4>Create Slider Events for the Music Volume Control</h4><br>

To create events on mouse drag, we need to implement several mouseDragged() events.<br>
We already did some parts of it for you in the code further down in the class.<br>
Please go ahead and extend the code so that it changes the music volume based on the slider level. <br>
You might find the following functions from the "Audio" and "Slider" classes useful: <br>
<br><pre>
music.changeVolume(double intensity);
Slider.getIntensity();</pre><br><br>

Once you finished your code, test if the music volume actually changes by first playing a song with the virtual touch button and then dragging the slider to adjust the music volume. If everything works, move on.<br><br>

<h4>Hide the Slider</h4><br>

Similar to the previously added buttons, you can hide the Slider by pressing the 'h' key on your keyboard while your program runs.<br>
If you want to see them again, press 's' (for show).<br><br>

<h4>Now Let's Change Music Volume from the Inkjet Printed Physical Card</h4><br>

Now that we can control the slider digitally, we also want to adjust the volume of the music from the physical card.<br><br>
Copy over your code that reads the slider value for the Serial Port from the other Processing application you just wrote and integrate it into the music card.<br>

<img src="images/lab4/lab2-volume-low_new.png" width="350px">
<img src="images/lab4/lab2-volume-middle_new.png" width="350px">
<!-- <img src="images/lab2-volume-high_UI.png" width="200px"> -->
<br><br>

Now test if everything works by using your physical printed card to play/pause songs and the physical slider to adjust the music volume. If it works, congrats, you are done :)!<br><br>

<h3>Deliverables</h3>

At the end of the lab, upload to your student google drive:
<ol>
 <li>the updated Arduino code you wrote for Serial Communication of the slider touch values (.ino file format)</li>
  <li>the Processing code (.pde) you wrote for Serial communication that displays the slider bar</li>
  <li>the Processing code (.pde) of the music card application with the slider</li>
  <li>a short video (.mov or .mp4, max. 1 minute) showing how you use the slider to adjust the volume</li>
</ol><br>
    


        <br />
        <br />
        <br />
      </section>

      
     <aside class="col-md-4 pull-left">
         <br /> <br /> <br /> <br /><br>

                 <h4 class="medium.headline" style="padding-bottom:10px;"><a href="lab-series-inkjet-printed-card.html"><b>Lab Series: Inkjet Printed Music Card</b></a><br></h4>

<ul>
    <li><a href="lab1-circuit-design-for-inkjet-printing.html">Lab 1: Circuit Drawings for Conductive Inkjet Printing</a></li>
    <li><a href="lab2-sensing-touch-button.html">Lab 2: Sensing Touch from Inkjet Printed Circuit</a></li>
   	<li><a href="lab3-sending-touch-data-to-processing.html">Lab 3: Sending Touch Data to Processing</a></li>
    <li><a href="lab4-touch-slider-extension.html">Lab 4: Sensing Input from a Touch Slider</a></li>
</ul><br>


<iframe width="280" height="158" src="https://www.youtube.com/embed/R7qxT6_8TE4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><br><br>

In this lab series, you will create an interactive music card. Underneath the visual design, the music card has an inkjet printed circuit with touch buttons and a slider that allow the user to play songs and control the volume. The card is connected to a microcontroller for analyzing user input and then sends the signals to a program called Processing for visualizing user input on screen.<br><br>


</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>

      </aside>

    </div>
  </div>
  </div>
</section>

<div class="container">
	<div class="row">
		<div class="col-md-12 footer" style="text-align: center;">
			<span class="copyright">
			Since 2017 &copy; MIT CSAIL (HCI Engineering group) [redesign by
			<a href="http://punpongsanon.info/" target="_blank" style="text-decoration:none; border-bottom:0px">
			moji
			</a>].
			All Rights Reserved.

			<a href="http://mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/mit.svg" alt="MIT" class="footer-logo" />
			</a>
			<a href="http://csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/csail.svg" alt="CSAIL" class="footer-logo"/>
			</a>
			<a href="http://hci.csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/hci.svg" alt="HCI" class="footer-logo"/>
			</a>
			</span>
		</div>
	</div>
</div>

<!-- Bootstrap -->
<script type="text/javascript" src="../../js/bootstrap.min.js"></script>
<!-- header -->
<script type="text/javascript" src="../../js/headerstrap-for-subpage.js"></script>

</body>
</html>
