<!DOCTYPE html>
<html>
<head>
	<title>HCI Engineering Group</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

	<!-- CSAIL ICON -->
	<link rel="CSAIL" href="../../../images/icon/csail.ico" type="image/x-icon" />

	<!-- Bootstrap -->
	<link href="../../css/bootstrap.css" rel="stylesheet">
	<link href="../../css/custom-style.css" rel="stylesheet">

	<!-- jQuery -->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Abel" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Barlow" rel="stylesheet">

	<!-- Google Analytic -->
	<script type="text/javascript" src="../../js/analytics.js"></script>

	<style>
	.etech-sch-col1 {width:60px; border: 1px solid black;padding:10px;}
	.etech-sch-col2 {width:120px; border: 1px solid black;padding:10px;}
	.etech-sch-col3 {width:450px; border: 1px solid black;padding:10px;}
	.etech-sch-col4 {width:70px; border: 1px solid black;padding:10px;}
  .etech-sch-col5 {width:70px; border: 1px solid black;padding:10px;}
  /*.etech-sch-col6 {width:170px; border: 1px solid black;padding:10px;}*/
  ul {
    padding:0px;padding-left:10px;margin:0px;
  }
	</style>
</head>

<body>
<header class="main_header">
	<!-- to be filled by javascript, see header.html -->
</header> 

<section class="main_container">
	<div class="container">
    <div class="row nothing">

      <section class="col-md-8 pull-right main-content">
</br></br></br></br>
        <h4 class="medium.headline"><a href="6810-engineering-interactive-technologies.html">6.810 Engineering Interactive Technologies (fall 2021)</a><br></h>
        <h2 class="headline">Lab 11: Control Circuit for the Interactive Lamp</h2>
      
In this lab, you will add the circuit to the lamp and then program the lamp to change its color when the user interacts with one of the touch buttons. There is also one touch button to turn the lamp on/off.<br><br>

<img src="images/lab10/circuit_1.jpg" width="350px">
<img src="images/lab10/circuit_done.jpg" width="350x"><br>


<h3>Steps:</h3>
<ol>
        <li><a href="#XXX">laser cut the fabric for the lamp shade</a></li>
        <li><a href="#XXX">sew the fabric lamp shade cover together</a></li>
        <li><a href="#XXX">embroider the touch button with conductive yarn</a></li>
        <li><a href="#XXX">connect the touch buttons to jumper wires</a></li>
        <li><a href="#XXX">add LEDs to the lamp shade</a></li>
        <li><a href="#XXX">build a control circuit for the touch sensors and LED lights and add it to the base of the lamp</a></li>
        <li><a href="#XXX">write a program that senses touch and controls the LEDs</a></li>
    </ol>


<h3>Deliverables</h3>
    
At the end of the lab, upload to your student google drive:
    <ol>
        <li>the ESP32 code to sense touch and control the LEDs</li>
        <li>2-3 photos (.jpg or .png) of your 3D printed lamp that shows the circuit and the assembled lamp</li>
        <li>a video that shows how the lamp turns on/off when touching the "on/off" button and how the lamp changes its color when pressing the three color scheme buttons</li>
    </ol><br>


      
 <h3 id="XXX">(1) Attach ESP to Mini-Breadboard</h3>
    
Now that the lamp shade is fully assembled, you can build the circuit for the touch buttons and the LEDs. Since the lamp base is too small for regular breadboards, we supply you with a mini-breadboard. <br><br>
    
<b>Tape ESP to Mini-Breadboard:</b> Remove the backing from the mini-breadboard, which will expose a layer of double-sided tape. Next, place your microcontroller onto the layer of double sided tape, the pins of the microcontroller should be facing away from the double sided tape (don't worry, the microcontroller is easy to pull off later if you need to remove it to work on your pset or project).<br><br>

    <img src="images/lab9/minib_1.png" width="380px">
    <img src="images/lab9/minib_2.png" width="330px"><br><br>
    
          
 <h3 id="XXX">(2) Build LED Control Circuit</h3>

Next, we will add the LEDs to our mini-breadboard. If you look at your LED strip, you can see that there are 3 pins labeled <code>GND, 5V, and DIN</code>. <br><br>
   
<b>Connect LED GND to GND pin on ESP:</b> Connect the LED GND wire to the GND pin on the microcontroller. Always connect the GND first to protect the LEDs from voltage spikes, which may blow them up!<br><br>

<b>Connect LED 5V to VIN pin on ESP:</b> The LEDs need 5V, not 3.3V as we have used so far in other labs. The ESP32 can supply 5V at the <code>VIN</code> pin. Usually, this pin is used to connect to an external power supply (e.g. external battery pack). However, if you connect your ESP with a USB cable to your computer, the pin will use the 5V power supply from the USB cable to drive the pin.<br><br>

<b>DIN (Data-In):</b> This channel is used to encode which LED should turn on with which color. Connect <code>DIN</code> to a GPIO pin of your ESP32.

<h3 id="XXX">(3) Build Touch Control Circuit</h3>

Now that the LEDs are wired up, we also need to build the touch control circuit.<br><br>

<b>Wire Up Conductive Yarn Touch Buttons to Microcontroller:</b> Wire up each of the four touch buttons to the ESP. If you don't remember how the circuit for touch buttons looks like, <a href="lab2-sensing-touch-button.html">you can look back at Lab 2.</a> Use a 100kOhm resistor between the sender pin and the 4 receiver pins (reuse your resistors from the music card). Your final circuit should look similar to this:<br><br>
    
    <img src="images/lab10/circuit_1.jpg" width="350px">
    <img src="images/lab10/circuit_2.jpg" width="350px"><br><br>

 <h3 id="XXX">(4) Mount LED and Touch Control Circuits into Lamp Base</h3>
    
Now place the circut inside your lamp base.<br><br>

<b>Stick USB cable through Lamp Base Hole:</b> First stick the USB cable through the hole in your 3D printed lamp base.<br><br>

<b>Connect USB cable to ESP:</b> Next, connect the USB cable to your ESP32 so you can program the lamp.<br><br>

<b>Place ESP with Circuit Inside Lamp Base:</b> Finally, carefully place the ESP with the circuit inside the lamp base. Don't put the lamp shade on top of the base just yet.<br><br>

    <img src="images/lab10/usb_1.png" width="350px">
    <img src="images/lab10/usb_2.png" width="350px"><br><br>
    

 <h3 id="XXX">(5) Program the Touch Sensing and LED Blinking</h3>

In this final step, we will write code that can sense touch on all four touch buttons, implement the on/off functionality for the on/off button, and implement the 3 light color programs that are triggered with the other 3 touch buttons.<br><br>
    
<b>Code for Touch Sensing</b><br>    
For touch sensing, you can reuse the code from lab 1+2.<br> 
Print your touch signals to the Serial Monitor/Plotter to see if it works.<br> 
Make sure that you get a clear signal from all 4 touch buttons.<br>
Select a suitable threshold for each touch button to detect touch.<br><br>
    
<b>Programming the LEDs</b><br>    

The LEDs on the strip are called NEOPIXELS (WS2812B).<br>
Each LED represents a 'pixel' that can be addressed individually and can thus change color and brightness independent of the other LEDs on the strip.<br> 
The DIN (Data-In) pin on the strip transmits a specific protocol to address each LED individually.<br>
This is why the LEDs do not turn on immediately when you connect them to the power supply.<br>
Instead we first have to provide data through the DIN pin.<br><br>
    
To control the LEDs, you can use a library that handles the signal encoding for you.<br> 
This library is called <b>FastLED</b>.<br> 
You can download it directly from the Arduino IDE by clicking on <b>Sketch->Inlcude Libraries->Manage Libraries.</b><br> 
Search for FastLED and install it.<br>
If you are interested to see what is available in the <a href="http://fastled.io/docs/3.1/annotated.html">FastLED library, you can look at the documentation here.</a> <br><br>
    
    <img src="images/lab10/fastled.png" width="700px"><br><br>

You have to include the library to be able to use it in your script:<br><br>

    <pre><code>#include &lt;FastLED.h&gt;</code></pre>

To declare an LED, you can use the CRGB datatype.<br>

<pre>
<code>CRGB led1;
</code></pre>

However, rather than declaring 4 LED variables individually to address each LED, we will use an array, which is more convenient.<br>

<pre><code>#define NUM_LEDS 4
    
CRGB leds[NUM_LEDS];
</code></pre>
    
The library also requires to add each LED to its internal data structures.<br> 
You can do this in the setup() function with the following line:<br>

<pre><code>FastLED.addLeds&lt;NEOPIXEL,LED_PIN&gt;(leds,NUM_LEDS)
</code></pre>

The function requires the following parameters:<br>
<b>NEOPIXEL:</b> The FastLED library is a generic library for all sorts of LED types. So we need to tell it which LED type we have so it knows which protocol to use to send the data to the LED. NEOPIXEL is a constant defined in the <a href="http://fastled.io/docs/3.1/annotated.html">documentation of the FastLED library</a> and we can simply use it as an argument here. <br>
<b>LED_PIN:</b> this is the GPIO pin to the DIN pin. This variable has to be a constant so you should declare it with #define.<br>
<b>leds + NUM_LEDS:</b> We already declared these above so you just insert them here.<br><br>
    
You can assign a color to an LED by writing:<br><br>

<pre><code>leds[0] = CRGB::White;
</code></pre>
    
This color does not get sent to the LED immediately each time you assign a color to an LED.<br> 
Instead, you have to make the sending explicit by executing the command:<br><br>

<pre><code>FastLED.show();
</code></pre>
    
<b>Changing LED Color on Touch</b><br>    
Let's bring it all together.<br>
Implement the following end-to-end workflow:<br>

<ol>
    <li>When the on/off button is touched and the lamp is off, the lamp should turn on.</li>
<li>When the lamp turns on, all the LEDs should be set to white.</li>
<li>Touching one of the color-scheme buttons will set the lights to a color scheme of your choice (e.g. red, green, blue or whatever color scheme you like).</li>
<li>Finally, when the on/off button is touched and the lamp is on, the lamp should turn off.</li>
</ol><br>

Once everything works, put the lamp shade on the base.<br><br>
    
    <img src="images/lab10/circuit_done.jpg" width="430x">
    <img src="images/lab10/lamp.jpg" width="240px"><br><br>
    
    ... and start filming :).<br><br>
    
    <iframe width="560" height="315" src="https://www.youtube.com/embed/05BrSUOn_-g" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

    
<h3>Deliverables</h3>
    
At the end of the lab, upload to your student google drive:
    <ol>
        <li>the ESP32 code to sense touch and control the LEDs</li>
        <li>2-3 photos (.jpg or .png) of your 3D printed lamp that shows the circuit and the assembled lamp</li>
        <li>a video that shows how the lamp turns on/off when touching the "on/off" button and how the lamp changes its color when pressing the three color scheme buttons</li>
    </ol><br>

        <br />
        <br />
        <br />
      </section>

       <aside class="col-md-4 pull-left">
         <br /> <br /> <br /> <br /><br>

                  <h4 class="medium.headline" style="padding-bottom:10px;"><a href="lab-series-3Dprinted-lamp-with-conductive-yarn.html"><b>Lab Series: 3D Printed Lamp with Conductive Yarn Buttons</b></a><br></h4>

<ul>
  <li><a href="lab9-3D-printing-lamp.html">Lab 9: 3D Printing the Lamp Base and Shade (2%)</a></li>
    <li><a href="lab10-conductive-yarn.html">Lab 10: Conductive Yarn for Creating the Lamp Shade (2%)</a> </li>
    <li><a href="lab11-interactive-lamp-control-circuit.html">Lab 11: Control Circuit for the Interactive Lamp (2%)</a></li>
</ul><br>


<iframe width="280" height="157" src="https://www.youtube.com/embed/05BrSUOn_-g" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><br><br>

In this lab series, you will build an interactive lamp that can change its color when the user touches one of its sewn on touch-buttons. The lamp consists of a 3D printed lamp base, a hand-sewn fabric cover with touch buttons stitched from conductive yarn, and integrated LEDs.<br><br>

</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>

      </aside>

    </div>
  </div>
  </div>
</section>

<div class="container">
	<div class="row">
		<div class="col-md-12 footer" style="text-align: center;">
			<span class="copyright">
			Since 2017 &copy; MIT CSAIL (HCI Engineering group) [redesign by
			<a href="http://punpongsanon.info/" target="_blank" style="text-decoration:none; border-bottom:0px">
			moji
			</a>].
			All Rights Reserved.

			<a href="http://mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/mit.svg" alt="MIT" class="footer-logo" />
			</a>
			<a href="http://csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/csail.svg" alt="CSAIL" class="footer-logo"/>
			</a>
			<a href="http://hci.csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/hci.svg" alt="HCI" class="footer-logo"/>
			</a>
			</span>
		</div>
	</div>
</div>

<!-- Bootstrap -->
<script type="text/javascript" src="../../js/bootstrap.min.js"></script>
<!-- header -->
<script type="text/javascript" src="../../js/headerstrap-for-subpage.js"></script>

</body>
</html>
