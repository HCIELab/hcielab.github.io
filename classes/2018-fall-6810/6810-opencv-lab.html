<!DOCTYPE html>
<html>
<head>
	<title>HCI Engineering Group</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

	<!-- CSAIL ICON -->
	<link rel="CSAIL" href="../../images/icon/csail.ico" type="image/x-icon" />

	<!-- Bootstrap -->
	<link href="../../css/bootstrap.css" rel="stylesheet">
	<link href="../../css/custom-style.css" rel="stylesheet">

	<!-- jQuery -->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Abel" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Barlow" rel="stylesheet">

	<!-- Google Analytic -->
	<script type="text/javascript" src="../../js/analytics.js"></script>

	<style>
	.etech-sch-col1 {width:60px; border: 1px solid black;padding:10px;}
	.etech-sch-col2 {width:120px; border: 1px solid black;padding:10px;}
	.etech-sch-col3 {width:450px; border: 1px solid black;padding:10px;}
	.etech-sch-col4 {width:70px; border: 1px solid black;padding:10px;}
  .etech-sch-col5 {width:70px; border: 1px solid black;padding:10px;}
  /*.etech-sch-col6 {width:170px; border: 1px solid black;padding:10px;}*/
  ul {
    padding:0px;padding-left:10px;margin:0px;
  }
	</style>
</head>

<body>
<header class="main_header">
	<!-- to be filled by javascript, see header.html -->
</header>

<section class="main_container">
	<div class="container">
    <div class="row nothing">

      <section class="col-md-8 pull-right main-content">
</br></br></br></br>
        <h4 class="medium.headline"><a href="6810-engineering-interactive-technologies.html">6.810 Engineering Interactive Technologies (fall 2018)</a><br></h>
        <h2 class="headline">OpenCV Lab</h2>

  <!-- <img src="images/laser-cutting/laser-cutter.png" width="183px" /> <img src="images/laser-cutting/laser-cutter-cutting.png" width="250px" /> -->
          <br>
          <hr>

<span style="color:red">work in progress</span>

<h3>Here's what we are building today:</h3><br>

We are going to write a piece of Computer Vision software that extracts the position of the colored squares from each side of a Rubrik's cube and then solves the cube by giving you instructions on how to rotate each row/column.<br><br>

<img src="images/opencv-lab/opencv-result.png" width="483px" /><br><br>

<!-- <span style="color:red">
<iframe width="560" height="315" src="https://www.youtube.com/embed/4uBRRA1gai0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</span> -->

Your job is to write the color-extraction with OpenCV. <br>
We will give you code for the rest (i.e. the logic for solving the cube).<br>



<br><br>

<h3>Where to place your code</h3><br>

In the code, you will find a function XX. 
Please insert your code into this function.


<h3>Reading a Camera Image</h3><br>

Before we can read the live camera feed, we first have to initialize the camera like this: <br><br>

<code>
/* Initializing the Camera * /
camera_port = 0  // your built in camera is typicall 0, any extra camera on USB is 1, 2 etc.<br>
camera = cv2.VideoCapture(camera_port) // this returns the camera object and opens the video channel<br>
</code>
<br><br>

Next, we can read frames from the camera like this:<br>

<code>
/* Initializing the Camera * /
read image code<br>
display image on screen<br>
add a wait so it doesn't fly<br><br>
ret, frame = camera.read()<br>
cv2.namedWindow('image',0)<br>
cv2.resizeWindow('image',800,600)<br>
</code>
<br>

We need to add the wait statement for ~5ms otherwise your computer will stall and not be able to take any key input from you. 
<code>
	key = cv2.waitKey(5)
</code>
<br><br>

<h3>Doing an Action on Key-Press</h3><br>

It is often useful for debugging to do some action on keypress (e.g. quit the program, save a specific image from the camera).<br><br>

Here is some code to e.g. quit your program on keypress of 'x'.<br><br>

<code>
/* Doing something on Keypress * /<br>
if key == 120:<br>
    &nbsp &nbsp break<br>
}<br>
</code>

<h3>Writing Frames to Disk</h3><br>

It is often a good idea to start developing a program on a single frame, aka a still image rather than trying to solve it right away with a live video stream, e.g. a single image in which you hold the rubriks cube into the camera.<br><br>

Expand your code to save a single frame to disk on keypress of 'c' (capture).<br>

<code>
/* Code for saving an image * /<br>
/* frame write to disk * /<br>
if key == 99:<br>
    &nbsp &nbsp img_name = "opencv_frame.png"<br>
    &nbsp &nbsp cv2.imwrite(img_name, frame)<br>

</code>
<br><br>

<h3>RGB, CMYK, and HSV Color Spaces for Color Tracking</h3><br>

RGB and CMYK are the most common color spaces.<br>
RGB is used for on-screen images, while CMYK is used for printed content.<br><br>


<img src="images/opencv-lab/rgb-cmyk.png" width="483px" /><br><br>


Your camera image is in RGB.<br>
Is RGB a good color space for tracking color?<br><br>

<img src="images/opencv-lab/rgb-problem1.png" width="683px" /><br><br>

RGB encodes color in 3 different channels: R, G, and B.<br>
For instance, the light orange in the image below consists of 227 Red parts mixed with 151 green parts and 83 blue parts.<br><br>

Even just slightly changing the lighting situation in the room, will result in a big mess, i.e. all of these numbers change! <br>
As you can see below, on a more sunny day, the same object might now be more saturated orange and all the numbers change. <br>
Thus, it will be very difficult to color track an object (such as the Rubrik cube squares) using RGB color space!<br><br>

<img src="images/opencv-lab/rgb-problem2.png" width="683px" /><br><br>

Now there is another color space called HSV (Hue, Satuation, Value).<br>
This color space is much more suitable for our needs, since the hue-channel encodes all the different colors in a single channel (see below).<br>
The saturation channel contains all the different saturated versions of this color and the value channel contains all the different brightness versions of this color.<br>
<br>

<img src="images/opencv-lab/hsv-color-space2.png" width="483px" /><br><br>

Thus, to track a specific color in HSV, we can simply select the range in Hue (e.g. 60-140 for green), and then include all saturations (0-255) and all values (0-255) of that color.<br> 
This allows us to track color independent of the current light situation in the room.<br><br>

<code>
	/* Code to convert your image into HSV color space */<br>
hsv_image = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV)<br>
</code>
<br>

If you display this image on your screen (make sure to use the hsv_image variable in the showImage() function), it will probably look super weird because your RGB display cannot display an HSV image (different color space).<br><br>

<img src="images/opencv-lab/hsv-color-space3.png" width="283px" /><br><br>

<h3>Thresholding an Image</h3><br>

Thresholding an image basically means going over every single pixel of an image, then for each pixel in the image the program asks: Is the pixel value above a certain threshold? If the answer is yes, the pixel is colored white, if the answer is no, the pixel is colored black. <br><br>

The same principle applies when you use a range: If the value of the pixel between the lower and upper bounds of the range, then color it white. If it is outside the bounds of the range, color it black.<br><br>

<img src="images/opencv-lab/threshold1.png" width="483px" /><br><br>

Here's the code for this:<br>

<code>
	*/define lower and upper range, e.g. for color blue*/<br>
lower_blue = np.array([h_min,s_min,v_min]) // e.g. 100,0,0<br>
upper_blue = np.array([h_max,s_max,v_max]) // e.g. 140,255,255<br>
<br>
*/threshold the image using the lower and upper bounds*/<br>
threshold_image = cv2.inRange(hsv_image, lower_blue, upper_blue)<br>
</code>
<br><br>

Let's start by just searching for one of the Rubrik cube's colors, such as red.<br>
Once you have this working, you can later extend your code to other colors (but we recommend moving on for now and doing one color end-to-end first.<br><br>

<h3>Adding Sliders for Setting Threshold Values</h3><br>

Rather than hard-coding the values, it is often a good idea to have some sliders to define the lower and upper bounds.<br><br>

Here is how you can add some sliders to set h_min, s_min, v_min, h_max, s_max, v_max:<br><br>

<code>
	*/adding sliders */<br><br>

	# nothing<br>
	def nothing():<br>
    &nbsp &nbsp pass<br><br>
	cv2.createTrackbar('h','image',25,179,nothing)<br>
	cv2.createTrackbar('s','image',50,255,nothing)<br>
	cv2.createTrackbar('v','image',50,255,nothing)<br>
	cv2.createTrackbar('H','image',35,179,nothing)<br>
	cv2.createTrackbar('S','image',255,255,nothing)<br>
	cv2.createTrackbar('V','image',255,255,nothing)<br>
</code>

<br><br>

<h3>Find Contours</h3><br>

Ok great, now you have a black and white image, but its just a soup of pixels.<br>
How can we find the contours?<br>

For this, OpenCV offers a handy function:<br>

<code>
	*/return contours */<br>
image, contours, hierarchy = cv2.findContours(threshold_image,<br>
                                       cv2.RETR_TREE,<br>
                                       cv2.CHAIN_APPROX_SIMPLE)<br>
</code><br>

In this example, the variable contours will be a list of paths, with each path being a contour found in the thresholded image (i.e. for every white blob).<br>

<img src="images/opencv-lab/contours1.png" width="283px" /><br><br>

Below you can find the arguments of the function explain.<br>
The cv2.RETR-TREE allows you to find out the hierachy of contours, e.g. is one contour inside some other contour. We don't really need this here since all the rubrik cube squares are right next to each other. However, we could use this function later to cancel out noise (e.g. small contours found inside some larger contour are probably noise).<br><br>

The cv2.Chain_approx_simple allows you to decide how many points for each contour you want. If you do not approximate the contour, the path object will be very large. For our case, getting an approximation is totally sufficient, so we use it here.<br><br>

<img src="images/opencv-lab/contours2.png" width="483px" /><br><br>

<h3>Drawing Contours on an Image</h3><br>

Next, we can draw the returned contours in the image, so we actually see something. <br>

<code>
	/* iterate over contours*/<br>
for contour in contours:<br>
    &nbsp &nbsp cv2.drawContours(frame, contour, -1, (0,255,0), 3) <br>
</code>

<br><br>

<h3>Filtering Noisy Contours</h3><br>

If you displayed your contours, you probably saw a lot of noise coming up.<br>
Since we are looking for large square shaped area, we can dismiss contours that are too small.<br><br>

<img src="images/opencv-lab/contours3.png" width="483px" /><br><br>

Since it's hard to guess the area, add a slider to your program that you can use to try different contour sizes for filtering!<br><br>

Once you are done, here's what you should see:<br><br>

<img src="images/opencv-lab/contours4.png" width="283px" /><br><br>

<h3>Fitting a Square around the Contour</h3><br>

The contour is just a path and thus it can have any shape and often has a noisy outline.<br>
We can fit a square around each contour and then use the square to compute the center point (i.e. location of the square within the image).<br>

<code>
	/* fitting a square around the contour */<br>
x,y,w,h = cv2.boundingRect(contour)<br>
//add line that queries the center<br>
</code>

<br>

We can now also draw the square into the image and add the coordinates to it:<br>

<code>
cv2.rectangle(frame,(x,y),(x+w,y+h),(0,255,0),5)<br>
cv2.putText(frame,textstring,(int(x+50),int(y)), 
            cv2.FONT_HERSHEY_SIMPLEX, 0.5,(255,255,255),1) <br>

</code>

<br>

This should give you this image:<br><br>

<img src="images/opencv-lab/fitting-square-around-contour.png" width="483px" /><br><br>

<h3>Extend Code to Work with all Colors on the Rubrik Cube</h3><br>

Now extend your code to work with all colors of the Rubrik cube.<br>
When you are done and you have the position of all squares, fill the position into this array (to come) so the rest of the code can provide you with the solution.<br><br>

<h3>Upload your Code and a Video of yourself solving your Cube to Gradebook</h3><br>

Upload your solution here.<br><br>


<br><br>






        <br />
        <br />
        <br />
      </section>

      <aside class="col-md-4 pull-left">

        <!-- Publication -->

        <br><br><br><br><br>
				<!-- <h4>Computer Vision Steps</h4><br> -->
		   <!--  <ul>
		    <li><a href="#step1">Install the Slicing Program (Cura)</a><br /></li>
		    <li><a href="#step2">Setup the Slicer Cura for the 3D Printer Prusa i3 Mk2</a><br /></li>
		    <li><a href="#step3">Find a 3D Model</a><br /></li>
		    <li><a href="#step4">Slice your 3D Model</a><br /></li>
				<li><a href="#step5">Export your sliced model for 3D Printing</a><br /></li>
				<li><a href="#step6">Print Your Model</a><br /></li>
				<li><a href="#step7">Unload Filament</a><br /></li>
				<li><a href="#step8">Load New Filament</a><br /></li>
				<li><a href="#step9">Remove your Print from the Build Plate</a><br /></li>
				<li><a href="#further">Further Reading while Waiting</a><br /></li>
				</ul> -->
        <!-- Publication -->

<!-- <h4>Side Bar</h4><br>

    <ul>
      <li>Prof. Stefanie Mueller (Instructor)</li>
      <li>Lotta-Gili Blumberg (TA)</li>
      <li>Xin Wen (UTA)</li>
      <li>Loren Maggiore (LA)</li>
      <li>Mark Chounlakone (LA)</li>
    </ul>
 -->
</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>

      </aside>

    </div>
  </div>
  </div>
</section>

<div class="container">
	<div class="row">
		<div class="col-md-12 footer" style="text-align: center;">
			<span class="copyright">
			Since 2017 &copy; MIT CSAIL (HCI Engineering group) [redesign by
			<a href="http://punpongsanon.info/" target="_blank" style="text-decoration:none; border-bottom:0px">
			moji
			</a>].
			All Rights Reserved.

			<a href="http://mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/mit.svg" alt="MIT" class="footer-logo" />
			</a>
			<a href="http://csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/csail.svg" alt="CSAIL" class="footer-logo"/>
			</a>
			<a href="http://hci.csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/hci.svg" alt="HCI" class="footer-logo"/>
			</a>
			</span>
		</div>
	</div>
</div>

<!-- Bootstrap -->
<script type="text/javascript" src="../../js/bootstrap.min.js"></script>
<!-- header -->
<script type="text/javascript" src="../../js/headerstrap-for-subpage.js"></script>

</body>
</html>
