<!DOCTYPE html>
<html>
<head>
	<title>HCI Engineering Group</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

	<!-- CSAIL ICON -->
	<link rel="CSAIL" href="../../images/icon/csail.ico" type="image/x-icon" />

	<!-- Bootstrap -->
	<link href="../../css/bootstrap.css" rel="stylesheet">
	<link href="../../css/custom-style.css" rel="stylesheet">

	<!-- jQuery -->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Abel" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Barlow" rel="stylesheet">

	<!-- Google Analytic -->
	<script type="text/javascript" src="../../js/analytics.js"></script>

	<style>
	.etech-sch-col1 {width:60px; border: 1px solid black;padding:10px;}
	.etech-sch-col2 {width:120px; border: 1px solid black;padding:10px;}
	.etech-sch-col3 {width:450px; border: 1px solid black;padding:10px;}
	.etech-sch-col4 {width:70px; border: 1px solid black;padding:10px;}
  .etech-sch-col5 {width:70px; border: 1px solid black;padding:10px;}
  /*.etech-sch-col6 {width:170px; border: 1px solid black;padding:10px;}*/
  ul {
    padding:0px;padding-left:10px;margin:0px;
  }
	</style>
</head>

<body>
<header class="main_header">
	<!-- to be filled by javascript, see header.html -->
</header>

<section class="main_container">
	<div class="container">
    <div class="row nothing">

      <section class="col-md-8 pull-right main-content">
</br></br></br></br>
        <h4 class="medium.headline"><a href="6810-engineering-interactive-technologies.html">6.810 Engineering Interactive Technologies (fall 2020)</a><br></h>
        <h2 class="headline">Problem Set Series: Multi-Touch Pad</h2>


<img src="images/pset-overall2.png" width="600px">

          <hr>


<h2 class="headline">Problem Set 2</h2>

In the second part of the problem set, you are going to do four steps:
<ul>
	<li>(1) Generate appropriate PWM signal </li>
	<li>(2) Configure the channel select for Multiplexer </li>
	<li>(3) Set up the ADC pins with MCP3008 chip and SPI </li>
<!-- 	<li>(1) Identify the GPIO pin configurations and assign corresponding PinMode</li>
	<li>(2) Generate appropriate PWM signal and assign to sender pins</li> -->
	<li>(4) Read and record analog signals from receiver pins in Serial channel</li>
	<!-- <li>(4) Add the "button" mode and record the data in Serial channel</li> -->
</ul>
<br>

<h3>(1) Generate appropriate PWM signal </h3>
Recall the circuit schematics from PSet1, now you will code up the "Sending" part of the circuit! <br><br>
<img src="images/pset1/multitouch-schematic-sending.png" width="600px"> <br><br>
We will start by generate the PWM signal for the circuit. <br>
You can download the skeleton code for the PSet2 from <a href="software/pset-skeleton_Arduino.zip"> here</a>. <br><br>

<h4>What is PWM?</h4><br>

Pulse Width Modulation, or PWM, is a technique for getting analog results with digital means. <br>
Digital control is used to create a square wave, a signal switched between on and off. This on-off pattern can simulate voltages in between full on (3.3 Volts) and off (0 Volts) by changing the portion of the time the signal spends on versus the time that the signal spends off.<br><br>

<img src="images/pset2/pwm-explanation.png" width="450px"> <br><br>

We know that in the frequency ranges from 100 kHz to 40 MHz the electric field around the body behaves as a quasi-static near-field. <br>
We will have a TX electrode transmits a signal in the MHz range, and in this frequency range, the quasi-static electric field allows for strong capacitive coupling between the TX electrode, the finger, and the RX electrode. <br>
Simply put, the finger can be considered a conductor that couples both electrodes. <br><br>

The signal that we are generating for the TX electrodes is <b>4 MHz, 25% Duty Cycle</b>. <br><br>

Here’s the steps you’ll have to follow to set up the ESP32 PWM using the Arduino IDE: <br>
1. First, you need to choose a PWM channel. There are 16 channels from 0 to 15. <br>
2. Then, you need to set the PWM signal frequency, in our case 4 MHz. <br>
3. You also need to set the signal’s duty cycle resolution. you have resolutions from 1 to 16 bits. <br>
4. Next, you need to specify to which GPIO or GPIOs the signal will appear upon (don't forget to set the correct PinMode). <br>
5. Generate the PWM signal with a duty cycle value. <br><br>

For step 1-3, you can use the following function: <br>
<pre>ledcSetup(PWM_Channel_Number, Frequency, duty_resolution)</pre>

Notice that the frequency and duty resolution of the PWM signal has an inverse effect on each other. <br>
The ESP32's clock is 80 MHz, and the duty resolution can be lowered down to 1 bit in which case the maximum frequency is 40 MHz, but only the duty of 50% is available. <br>
The available duty levels are <b>(2^bit_num)-1</b>, where bit_num can be 1-15. <br>
The maximal frequency is <b>80000000 / 2^bit_num</b>. <br>
We will let you figure out the correct values for those parameters :) <br><br>

For step 4, you can use the following function: <br>
<pre>ledcAttachPin(GPIO_PIN , PWM_Channel_Number) </pre> <br>

For step 5, you can use the following function: <br>
<pre>ledcWrite(PWM_Channel_Number, DUTY_CYCLE): </pre> <br>

The code should be inside of the "<b>setupPWM()</b>" function in the skeleton code. <br>
<img src="images/pset2/setup-pwm.png" width="450px"> <br>

You can test if you have the correct signal via an oscilloscope. <br><br>

<h3>(2) Configure the channel select for Multiplexer</h3>

Next, we will write up the channel select function for multiplexer. <br>
You should first identify the appropriate GPIO pins for the multiplexer select pins (S0 - S3), and set the correct PinMode. <br><br>

Then you should fill out the "<b>selectChannelOut(int channel)</b>" function in the skeleton code. <br>
<img src="images/pset2/select-channel-mux.png" width="450px"> <br>

The function will take an int for channel number (0 - 7), and and assign the correct bit values to the 4 select pins (S0 - S3). <br><br>

You can test if the function work properly by assigning specific output channel number and test the value on the select output channel to see if it is assigned with the signal. <br>
You can test that by an oscilloscope or a multimeter. <br><br>

<h3>(3) Set up the ADC pins with MCP3008 chip and SPI </h3>
Now that we will move onto the "Receiving" part of the circuit! <br>
Recall the circuit schematics from PSet1: <br>
<img src="images/pset1/multitouch-schematic-receiving.png" width="600px"> <br><br>

In the schematics, we have all the receiver pins (RXn) connected to ADC (analog to digital converter) pins. <br>

Notice that we have ADC pins on ESP32, however, we are going to use external ADC channels from the <a href="https://www.adafruit.com/product/856">MCP3008 </a> chip, and communicate with ESP32 via SPI. <br>
You can find the datasheet for MCP3008 <a href="https://cdn-shop.adafruit.com/datasheets/MCP3008.pdf">here</a>.<br><br>

The reason for that is althrough the ESP32's ADC is extremely reliable in the middle of its range (~0.5V to maybe 3.0V), while at the extremes of its range, it is non-linear and without proper calibration behaves poorly. <br>
Since we are practically generating an AC signal with the PWM, plus the capacitive coupling effect between breadboard channels and wires under high frequency signal, we will end up with some negative voltages on the ADC pins, which are out of spec of the ESP32's ADC inputs. <br><br>

You could make the ESP32 work with this by adding rectification circuits and amplifiers before going into the ADC, but then you have to build it.  It is easier to use another ADC that can work in this regime. <br><br>

This is better in terms of scalability as well, since you can connect multiple ADC chips with SPI simultaneously, which allows us to arbirarily add more ADCs using a common SPI bus (so 4 pins gives 8 ADC channels and 5 pins gives 16 etc.).<br><br>

The pinout of the MCP3008 chip and circuit schematic are shown down below: <br>
<img src="images/pset2/MCP3008-pinout.png" width="200px">
<img src="images/pset2/mcp3008-schematic.png" width="500px"> <br><br>

You will also find the following ESP32 pinout useful for identifying SPI pins: <br>
<img src="images/pset2/esp32-pinout.png" width="750px"> <br><br>

Once you have the circuit build up, you can download the MCP3008 library and construct & initialize it in the skeleton code. <br><br>
<img src="images/pset2/mcp3008-library.png" width="500px"> <br><br>


<h3>(1) Identify the GPIO pin configurations and assign corresponding PinMode</h3>

Recall the circuit schematics from PSet1, now you will identify and confiugure them in the code! <br>
PWM pin as OUTPUT for signal input pin of the multiplexer <br>
ADC pihns as INPUT for receiver pins of multi-touch pad <br>
GPIO pins as OUTPUT for select pins of the multiplexer <br>
Appropriate Vcc pin and GND for the multiplexer <br>

<h3>(2) Generate appropriate PWM signal and assign to sender pins</h3>

Once you feel your circuit design looks right, inkjet print it.<br>
You will need two sheets, one for the columns and one for the rows.<br>

<h3>(3) Read and test analog signals from receiver pins</h3>

Once you printed both sheets, you can glue them together using a thin adhesive foil.

<h3>(4) Add the "button" mode and record the data in Serial channel</h3>

Finally, clip on both FCP chips to make sure you got the connection pads right.

<br>

<h3>Grading</h3>

We will give 25 pts in total:
<ul>
	<li>5 pts: you finished all for steps of the task.</li>
	<li>5 pts: circuit design: are all measurements correct, i.e. do the diamonds have the right size, is the spacing correct, do the wires actually connect to the FCP correctly.</li>
	<li>5 pts: inkjet printing: the print is highly conductive and all columns and rows have a low resistance.</li>
	<li>5 pts: assembly: did you assemble the layers correctly, are they correctly aligned, are the sheets stacked in the correct way.</li>
	<li>5 pts: connect to FCP: your multi-touch pad connects correctly to the FCP chips, nothing is misaligned.</li>
</ul>



        <br />
        <br />
      </section>

      <aside class="col-md-4 pull-left">
         <br /> <br /> <br /> <br />
<!-- 				 <h4>Pset Steps</h4><br>
				 <ul>
		 			<li><a href="#pset1">pset1 (due Sept. 21, 11.59pm): laser cut and bend the acrylic base</a><br /></li>
		 			<li><a href="#pset2">pset2 (due Oct. 5, 1pm): insert LEDs, add USB connecting and solder everything</a><br /></li>
		 			<li><a href="#pset3">pset3 (due Oct. 19, 1pm): write touch recognition so that you can determine (x,y) location of each finger</a><br /></li>
		 			<li><a href="#pset4">pset4 (due Oct. 26, 1pm): add an application of your choice</a><br /></li>
				</ul>
				<br /> <br /> <br /> <br />
        <img src="../2018-fall-6810/images/multi-touch-pad/iap1.jpg" width="220px">

		<img src="../2018-fall-6810/images/multi-touch-pad/iap2.jpg" width="220px">

		<img src="../2018-fall-6810/images/multi-touch-pad//iap3.jpg" width="220px">

		<img src="../2018-fall-6810/images/multi-touch-pad/iap4.jpg" width="220px">

		<img src="../2018-fall-6810/images/multi-touch-pad/iap5.jpg" width="220px">
 -->



        <!-- Publication -->

        <br><br><br><br><br>

        <!-- Publication -->

<!-- <h4>Side Bar</h4><br>

    <ul>
      <li>Prof. Stefanie Mueller (Instructor)</li>
      <li>Lotta-Gili Blumberg (TA)</li>
      <li>Xin Wen (UTA)</li>
      <li>Loren Maggiore (LA)</li>
      <li>Mark Chounlakone (LA)</li>
    </ul>
 -->
</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>

      </aside>

    </div>
  </div>
  </div>
</section>

<div class="container">
	<div class="row">
		<div class="col-md-12 footer" style="text-align: center;">
			<span class="copyright">
			Since 2017 &copy; MIT CSAIL (HCI Engineering group) [redesign by
			<a href="http://punpongsanon.info/" target="_blank" style="text-decoration:none; border-bottom:0px">
			moji
			</a>].
			All Rights Reserved.

			<a href="http://mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/mit.svg" alt="MIT" class="footer-logo" />
			</a>
			<a href="http://csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/csail.svg" alt="CSAIL" class="footer-logo"/>
			</a>
			<a href="http://hci.csail.mit.edu/" target="_blank" style="text-decoration:none; border-bottom:0px">
			<img src="../../images/logo/hci.svg" alt="HCI" class="footer-logo"/>
			</a>
			</span>
		</div>
	</div>
</div>

<!-- Bootstrap -->
<script type="text/javascript" src="../../js/bootstrap.min.js"></script>
<!-- header -->
<script type="text/javascript" src="../../js/headerstrap-for-subpage.js"></script>

</body>
</html>
